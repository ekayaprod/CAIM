<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CA IM Discovery Tool</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #28a745;
            --accent-hover: #20c997;
            --info-color: #17a2b8;
            --warning-color: #ffc107;
            --purple-color: #6f42c1;
            --danger-color: #dc3545;
            --light-bg: #f8f9fa;
            --text-light: #ecf0f1;
            --text-dark: #212529;
            --border-color: #dee2e6;
        }

        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            color: var(--text-dark);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .content {
            padding: 30px;
        }
        
        .btn {
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--accent-hover) 100%);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
        
        .btn-info { background: linear-gradient(135deg, var(--info-color) 0%, #138496 100%); }
        .btn-warning { background: linear-gradient(135deg, var(--warning-color) 0%, #e0a800 100%); color: var(--text-dark); }
        .btn-copy { background: linear-gradient(135deg, var(--purple-color) 0%, #5a32a3 100%); }
        .btn-modal-close { background: linear-gradient(135deg, #6c757d 0%, #495057 100%); }
        .btn-danger { background: linear-gradient(135deg, var(--danger-color) 0%, #c82333 100%); }
        
        .results, .config-output {
            background: var(--primary-color);
            color: var(--text-light);
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .config-output {
            background: #1e1e1e;
            border: 2px solid var(--purple-color);
        }
        
        .instructions {
            background: #e8f4fd;
            border-left: 4px solid #0084ff;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 0 8px 8px 0;
        }
        
        .step {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
        }
        
        .step h3 {
            color: var(--primary-color);
            margin-top: 0;
            font-size: 1.2rem;
        }
        
        .status {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: block; 
            margin-top: 10px;
            max-width: fit-content;
        }
        
        .status-ready { background: #d4edda; color: #155724; }
        .status-pending { background: #fff3cd; color: #856404; }

        textarea {
            width: 100%; 
            height: 150px; 
            font-family: monospace; 
            font-size: 0.9rem; 
            padding: 10px; 
            border: 1px solid var(--border-color); 
            border-radius: 5px;
        }
        
        /* Custom Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0s linear 0.3s;
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
            transition: opacity 0.3s ease;
        }

        .modal-box {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 500px;
            text-align: center;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal-overlay.visible .modal-box {
            transform: scale(1);
        }

        .modal-box p {
            margin: 0 0 20px 0;
            font-size: 1.1rem;
            color: #495057;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç CA Identity Manager Discovery Tool</h1>
            <p>Automatically gather configuration details for PowerShell automation</p>
        </div>
        
        <div class="content">
            <div class="instructions">
                <h3>üìã How to Use This Discovery Tool</h3>
                <ol>
                    <li><strong>Install the Discovery Bookmarklet:</strong> Drag the red button below to your browser's bookmarks bar.</li>
                    <li><strong>Navigate to your CA IM admin portal</strong> and log in.</li>
                    <li><strong>On each relevant page</strong> (e.g., login, user search, user management), click the Discovery bookmarklet.</li>
                    <li><strong>Copy the results</strong> from the discovery panel that appears.</li>
                    <li><strong>Paste the results</strong> into the corresponding text boxes below.</li>
                    <li><strong>Note on CSP:</strong> If the bookmarklet doesn't run, your portal may have a strict Content Security Policy (CSP). Try pasting the script from this page's source code (inside the `bookmarklet-src` template) directly into your browser's developer console on the target page.</li>
                </ol>
            </div>

            <div class="step">
                <h3>üîó Step 1: Install Discovery Bookmarklet</h3>
                <!-- REPLACE the previous <a href="javascript:..."> element with this -->
                <p>Drag this button to your bookmarks bar:</p>
                <a id="caimBookmarklet" class="btn btn-danger" href="#" title="Drag to bookmarks">üîç CA IM Discovery Bookmarklet</a>

                <!-- Keep the bookmarklet source here (template) so HTML parsing never treats it as active JS -->
                <script type="text/template" id="bookmarklet-src">
                (function(){
                  if(document.getElementById('caim-discovery-wrapper')){ return; }
                  const d = document;
                  const wrapper = d.createElement('div');
                  wrapper.id = 'caim-discovery-wrapper';
                  const html = '<div id="caim-discovery" style="position:fixed;top:20px;left:20px;width:450px;background:white;border:3px solid #dc3545;border-radius:10px;padding:20px;z-index:99999;box-shadow:0 10px 30px rgba(0,0,0,0.5);font-family:Arial,sans-serif;font-size:14px;"><h3 style="margin:0 0 15px 0;color:#dc3545;text-align:center;">üîç CA IM Page Discovery</h3><div id="caim-message" style="background:#d4edda;color:#155724;padding:10px;border-radius:5px;margin-bottom:10px;display:none;text-align:center;font-weight:bold;"></div><div style="max-height:300px;overflow-y:auto;background:#f8f9fa;padding:15px;border-radius:5px;margin-bottom:15px;"><pre id="discovery-results" style="font-size:11px;line-height:1.3;margin:0;white-space:pre-wrap;word-break:break-all;"></pre></div><div style="text-align:center;"><button id="bkm-copy" style="background:#28a745;color:white;border:none;padding:10px 20px;border-radius:5px;cursor:pointer;margin:5px;">üìã Copy Results</button><button id="bkm-scan" style="background:#17a2b8;color:white;border:none;padding:10px 20px;border-radius:5px;cursor:pointer;margin:5px;">üî¨ Deep Scan</button><button id="bkm-close" style="background:#6c757d;color:white;border:none;padding:10px 20px;border-radius:5px;cursor:pointer;margin:5px;">‚úñ Close</button></div></div>';
                  wrapper.innerHTML = html;
                  d.body.appendChild(wrapper);

                  // small helper UI message
                  const showBkmMessage = (msg, isError) => {
                    const el = d.getElementById('caim-message');
                    if(!el) return;
                    el.textContent = msg;
                    el.style.background = isError ? '#f8d7da' : '#d4edda';
                    el.style.color = isError ? '#721c24' : '#155724';
                    el.style.display = 'block';
                    setTimeout(()=>{ el.style.display = 'none'; }, 3500);
                  };

                  const runDiscovery = () => {
                    let info = 'üåê PAGE INFORMATION\\n' + '='.repeat(40) + '\\n';
                    info += 'Page Title: ' + (d.title || '') + '\\n';
                    info += 'Current URL: ' + (location.href || '') + '\\n\\n';
                    info += 'üìù FORMS ANALYSIS\\n' + '='.repeat(40) + '\\n';
                    const forms = d.querySelectorAll('form');
                    info += 'Total Forms: ' + forms.length + '\\n\\n';
                    if(forms.length === 0){
                      info += 'No forms found on this page.\\n\\n';
                    } else {
                      forms.forEach((form,i) => {
                        info += 'Form ' + (i+1) + ':\\n';
                        info += '  Action: ' + (form.action || 'N/A') + '\\n';
                        info += '  Method: ' + ((form.method || 'GET').toUpperCase()) + '\\n';
                        const inputs = form.querySelectorAll('input, textarea, select');
                        info += '  Fields (' + inputs.length + '):\\n';
                        if(inputs.length > 0){
                          inputs.forEach(input => {
                            const type = input.type || input.tagName.toLowerCase();
                            const name = input.name || input.id || 'unnamed';
                            info += '    - ' + (type + '          ').slice(0,10) + ' name="' + name + '"\\n';
                          });
                        } else {
                          info += '    No fields found in this form.\\n';
                        }
                        info += '\\n';
                      });
                    }
                    d.getElementById('discovery-results').textContent = info;
                    window.discoveryData = info;
                  };

                  const runFullDiscovery = () => {
                    let info = window.discoveryData || '';
                    info += '\\n\\nüî¨ DEEP SCAN RESULTS\\n' + '='.repeat(40) + '\\n';
                    const hiddenInputs = d.querySelectorAll('input[type="hidden"]');
                    info += 'Hidden Inputs (' + hiddenInputs.length + '):\\n';
                    if(hiddenInputs.length > 0){
                      Array.from(hiddenInputs).slice(0,15).forEach(input => {
                        const name = input.name || input.id || 'unnamed';
                        info += '- name="' + name + '" value="' + (input.value || '') + '"\\n';
                      });
                    } else {
                      info += 'None found.\\n';
                    }

                    // also capture potential management anchors/buttons
                    const actionables = [];
                    Array.from(d.querySelectorAll('a, button, input[type="submit"], input[type="button"]')).forEach(el => {
                      if(el.getAttribute('onclick') || el.dataset.action || el.href && el.href.includes('action') ) {
                        actionables.push({
                          tag: el.tagName.toLowerCase(),
                          text: (el.innerText || el.value || '').trim().slice(0,60),
                          href: el.href || '',
                          onclick: el.getAttribute('onclick') || '',
                          data: JSON.stringify(el.dataset)
                        });
                      }
                    });
                    info += '\\nPotential action elements (' + actionables.length + '):\\n';
                    if(actionables.length > 0){
                      actionables.slice(0,25).forEach(a => {
                        info += `- ${a.tag} text="${a.text}" href="${a.href}" onclick="${a.onclick}" data='${a.data}'\\n`;
                      });
                    } else {
                      info += 'None detected.\\n';
                    }

                    d.getElementById('discovery-results').textContent = info;
                    window.discoveryData = info;
                    showBkmMessage('Deep Scan Complete!');
                  };

                  const copyDiscoveryResults = () => {
                    const text = window.discoveryData || '';
                    if(!text){ showBkmMessage('No data to copy!', true); return; }
                    if(navigator.clipboard && navigator.clipboard.writeText){
                      navigator.clipboard.writeText(text).then(()=>{ showBkmMessage('Results copied!'); }).catch(()=>{ fallbackCopy(text); });
                    } else {
                      fallbackCopy(text);
                    }

                    function fallbackCopy(t){
                      const ta = d.createElement('textarea');
                      ta.value = t;
                      ta.style.position = 'fixed';
                      ta.style.opacity = '0';
                      d.body.appendChild(ta);
                      ta.select();
                      try { d.execCommand('copy'); showBkmMessage('Results copied!'); } catch(e){ showBkmMessage('Automatic copy failed.', true); }
                      d.body.removeChild(ta);
                    }
                  };

                  d.getElementById('bkm-copy').onclick = copyDiscoveryResults;
                  d.getElementById('bkm-scan').onclick = runFullDiscovery;
                  d.getElementById('bkm-close').onclick = ()=>{ wrapper.remove(); };

                  runDiscovery();
                })();
                </script>
                <div class="status status-ready">Ready to install</div>
            </div>

            <div class="step">
                <h3>üìÑ Step 2: Discover Login Page</h3>
                <p>Go to your CA IM login page, click the discovery bookmarklet, then paste results here:</p>
                <textarea id="loginPageData" placeholder="Paste login page discovery results here..."></textarea>
                <div class="status status-pending" id="loginStatus">Waiting for data...</div>
            </div>

            <div class="step">
                <h3>üîç Step 3: Discover User Search Page</h3>
                <p>Navigate to the user search page, run the bookmarklet, and paste results:</p>
                <textarea id="searchPageData" placeholder="Paste user search page discovery results here..."></textarea>
                <div class="status status-pending" id="searchStatus">Waiting for data...</div>
            </div>

            <div class="step">
                <h3>‚öôÔ∏è Step 4: Discover User Management Page</h3>
                <p>Go to a user's management page (e.g., where you unlock accounts), run the bookmarklet, and paste results:</p>
                <textarea id="managementPageData" placeholder="Paste user management page discovery results here..."></textarea>
                <div class="status status-pending" id="managementStatus">Waiting for data...</div>
            </div>

            <div class="step">
                <h3>üîß Step 5: Generate & Review Configuration</h3>
                <button class="btn" onclick="generatePowerShellConfig()">üöÄ Generate Configuration</button>
                <button class="btn btn-copy" onclick="copyConfig()">üìã Copy Config</button>
                <button class="btn btn-info" onclick="downloadConfig()">üíæ Download Config</button>
                <div id="powershellConfig" class="config-output" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Custom Modal for Notifications -->
    <div id="customModal" class="modal-overlay">
        <div class="modal-box">
            <p id="modalMessage"></p>
            <button id="modalCloseBtn" class="btn btn-modal-close">Close</button>
        </div>
    </div>

    <script>
        // --- Modal Notification Logic ---
        function showModal(message) {
            const modal = document.getElementById('customModal');
            const messageEl = document.getElementById('modalMessage');
            if (modal && messageEl) {
                messageEl.textContent = message;
                modal.classList.add('visible');
            }
        }

        // --- Core Application Logic ---
        function updateStatus(textareaId, statusId) {
            const textarea = document.getElementById(textareaId);
            const status = document.getElementById(statusId);
            if (!textarea || !status) return;
            
            if (textarea.value.trim().length > 50) {
                status.className = 'status status-ready';
                status.textContent = '‚úÖ Data received';
            } else {
                status.className = 'status status-pending';
                status.textContent = 'Waiting for data...';
            }
        }
        
        function parseDiscoveryData(data) {
            const info = {
                url: (data.match(/Current URL:\s*(.*)/)?.[1] || '').trim(),
                forms: [],
                actions: []
            };

            // split into blocks by Form N:
            const formBlocks = data.split(/(^|\n)Form\s+\d+:/).filter(Boolean);
            // The split above may produce interleaved parts; we will search for Action/Method/Fields patterns.
            const reForm = /Action:\s*(.*)\n\s*Method:\s*(.*)\n([\s\S]*?)(?=(\nForm\s+\d+:|\n$))/g;
            let match;
            while ((match = reForm.exec(data)) !== null) {
                const action = (match[1] || '').trim();
                const method = (match[2] || 'GET').trim().toUpperCase();
                const block = match[3] || '';
                const form = { action, method, fields: [] };

                // Look for lines like: - type    name="fieldName"  OR - type name='fieldName'
                const fieldRe = /-\s*(.*?)\s+name\s*=\s*["'](.*?)["']/g;
                let f;
                while ((f = fieldRe.exec(block)) !== null) {
                    form.fields.push({ type: (f[1] || '').trim(), name: (f[2] || '').trim() });
                }
                info.forms.push(form);
            }

            // Detect potential actions reported in deep scan (anchors/buttons)
            const actionBlockMatch = data.match(/Potential action elements[\s\S]*/);
            if (actionBlockMatch) {
                const lines = actionBlockMatch[0].split('\n');
                for (const ln of lines) {
                    const m = ln.match(/-\s*(\w+)\s+text="([^"]*)" href="([^"]*)" onclick="([^"]*)" data='([^']*)'/);
                    if (m) {
                        info.actions.push({ tag: m[1], text: m[2], href: m[3], onclick: m[4], data: m[5] });
                    }
                }
            }

            return info;
        }

        function generatePowerShellConfig() {
            const loginData = document.getElementById('loginPageData').value;
            const searchData = document.getElementById('searchPageData').value;
            const managementData = document.getElementById('managementPageData').value;
            
            if (!loginData || !searchData || !managementData) {
                showModal('Please collect and paste data from all three pages before generating the configuration.');
                return;
            }
            
            const loginInfo = parseDiscoveryData(loginData);
            const searchInfo = parseDiscoveryData(searchData);
            const managementInfo = parseDiscoveryData(managementData);

            // --- Input Data Validation ---
            const validationErrors = [];
            if (!loginInfo.url || loginInfo.forms.length === 0) {
                validationErrors.push('Login Page data appears invalid. Please re-run discovery and paste the full results.');
            }
            if (!searchInfo.url || searchInfo.forms.length === 0) {
                validationErrors.push('User Search Page data appears invalid. Please re-run discovery and paste the full results.');
            }
            if (!managementInfo.url) { // Management page might not have forms, but should have a URL
                validationErrors.push('User Management Page data appears invalid. Please re-run discovery and paste the full results.');
            }

            if (validationErrors.length > 0) {
                showModal(validationErrors.join('\n\n'));
                return;
            }

            // Intelligent field guessing
            const guessField = (forms, keywords) => {
                for (const form of forms) {
                    for (const field of form.fields) {
                        for (const keyword of keywords) {
                            if (field.name.toLowerCase().includes(keyword)) return field.name;
                        }
                    }
                }
                return `UPDATE_FIELD_NAME`;
            };

            const usernameField = guessField(loginInfo.forms, ['user', 'login', 'username', 'principal']);
            const passwordField = guessField(loginInfo.forms, ['pass', 'pwd', 'credential']);
            const searchField = guessField(searchInfo.forms, ['search', 'query', 'filter', 'user']);
            
            let baseUrl = "https://your-caim-server.com";
            try {
                if (loginInfo.url) {
                    const url = new URL(loginInfo.url);
                    baseUrl = `${url.protocol}//${url.hostname}`;
                }
            } catch(e) { /* Keep default if URL is invalid */ }
            
            function psEscape(s) {
              if (!s) return '';
              return s.replace(/`/g, '``').replace(/"/g, '`"');
            }

            const discoveredFieldsToString = (forms) => {
                let fieldComments = [];
                forms.forEach(form => {
                   form.fields.forEach(field => {
                       const t = (field.type || '').padEnd(10);
                       const n = psEscape(field.name || '');
                       fieldComments.push(`        # Type: ${t}, Name: "${n}"`);
                   });
                });
                return fieldComments.length > 0 ? fieldComments.join('\n') : "        # No form fields discovered on this page.";
            };

            const config = `# =============================================================================
# CA Identity Manager PowerShell Configuration
# Generated by Discovery Tool on ${new Date().toLocaleString()}
# REVIEW AND UPDATE ALL "UPDATE_*" VALUES
# =============================================================================

# NOTE: This file contains comments you can copy to your real script. The hashtable below
# contains the discovered values used by the sample functions further down.

$Global:CAIMConfig = @{
    BaseURL               = "${psEscape(baseUrl)}"
    LoginPageURL          = "${psEscape(loginInfo.url || 'UPDATE_LOGIN_URL')}"
    UserSearchPageURL     = "${psEscape(searchInfo.url || 'UPDATE_SEARCH_URL')}"
    UsernameField         = "${psEscape(usernameField)}"
    PasswordField         = "${psEscape(passwordField)}"
    SearchRequestURL      = "${psEscape(searchInfo.forms[0]?.action || searchInfo.url || 'UPDATE_SEARCH_ACTION_URL')}"
    SearchField           = "${psEscape(searchField)}"
    UnlockUserActionURL   = "UPDATE_URL_FOR_UNLOCK_ACTION"
    ResetPasswordActionURL= "UPDATE_URL_FOR_RESET_ACTION"
    UserAgent             = "PowerShell-CAIM-Automation/1.0"
    RequestTimeoutSec     = 60
}

# --- Discovered fields for reference ---
# --- Login Page Fields ---
${discoveredFieldsToString(loginInfo.forms)}

# --- Search Page Fields ---
${discoveredFieldsToString(searchInfo.forms)}

# --- Management Page Fields ---
${discoveredFieldsToString(managementInfo.forms)}

# -------------------------
# Example helper functions (minimal skeletons)
# -------------------------
function New-CAIMSession {
    param(
      [string]$Username,
      [string]$Password
    )
    # Use a session variable to hold cookies and reuse them across calls
    $form = @{
        "${psEscape(usernameField)}" = $Username
        "${psEscape(passwordField)}" = $Password
    }

    try {
        $response = Invoke-WebRequest -Uri $Global:CAIMConfig.LoginPageURL -Method Post -Form $form -SessionVariable caimSession -TimeoutSec $Global:CAIMConfig.RequestTimeoutSec -UseBasicParsing
        Write-Host "Login request sent. Status: $($response.StatusCode)"
        return $caimSession
    } catch {
        Write-Warning "Login failed: $_"
        return $null
    }
}

function CAIM-SearchUser {
    param(
      [string]$Query,
      $Session
    )
    $form = @{
       "${psEscape(searchField)}" = $Query
    }
    try {
        $r = Invoke-WebRequest -Uri $Global:CAIMConfig.SearchRequestURL -Method Post -Form $form -WebSession $Session -TimeoutSec $Global:CAIMConfig.RequestTimeoutSec -UseBasicParsing
        return $r
    } catch {
        Write-Warning "Search failed: $_"
        return $null
    }
}

# End of generated configuration. Update the placeholders and test against a non-production account.
`;

            const configElement = document.getElementById('powershellConfig');
            configElement.innerHTML = `<pre>${config}</pre>`;
            configElement.style.display = 'block';
            showModal('PowerShell configuration generated successfully! Please review and update placeholder values.');
        }

        function copyConfig() {
            const configElement = document.querySelector('#powershellConfig pre');
            if (!configElement || !configElement.textContent) {
                showModal('Please generate the configuration first.');
                return;
            }
            const config = configElement.textContent;

            const fallbackCopy = (text) => {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed'; // Prevent page from scrolling
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    showModal('PowerShell configuration copied to clipboard!');
                } catch (err) {
                    showModal('Failed to copy configuration automatically. Please copy manually.');
                }
                document.body.removeChild(textarea);
            };

            if (navigator.clipboard?.writeText) {
                navigator.clipboard.writeText(config).then(() => {
                    showModal('PowerShell configuration copied to clipboard!');
                }).catch(() => {
                    fallbackCopy(config);
                });
            } else {
                fallbackCopy(config);
            }
        }
        
        function downloadConfig(filename='caim-config.ps1') {
          const pre = document.querySelector('#powershellConfig pre');
          if(!pre) { showModal('Generate config first.'); return; }
          const blob = new Blob([pre.textContent], { type: 'text/plain' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('loginPageData').addEventListener('input', () => updateStatus('loginPageData', 'loginStatus'));
            document.getElementById('searchPageData').addEventListener('input', () => updateStatus('searchPageData', 'searchStatus'));
            document.getElementById('managementPageData').addEventListener('input', () => updateStatus('managementPageData', 'managementStatus'));
            
            const modal = document.getElementById('customModal');
            const modalCloseBtn = document.getElementById('modalCloseBtn');
            if (modal && modalCloseBtn) {
                modalCloseBtn.addEventListener('click', () => modal.classList.remove('visible'));
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.classList.remove('visible');
                });
            }
        });
    </script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Build bookmarklet href from template
      try {
        const srcEl = document.getElementById('bookmarklet-src');
        const link = document.getElementById('caimBookmarklet');
        if (!srcEl || !link) return;

        // Read template content
        let code = srcEl.textContent || srcEl.innerText || '';

        // Minify: remove comments, newlines, repeated spaces (very basic)
        code = code.replace(/\/\*[\s\S]*?\*\/|\/\/.*$/gm, ''); // remove comments
        code = code.replace(/\n+/g, ' ');
        code = code.replace(/\s{2,}/g, ' ');
        code = code.trim();

        // Wrap into IIFE if not already wrapped
        if (!/^(\(function|\(\s*async\s*function)/.test(code)) {
          code = '(function(){' + code + '})();';
        }

        // Create bookmarklet string
        const bookmarklet = 'javascript:' + encodeURIComponent(code);

        // Set href; using setAttribute ensures proper markup
        link.setAttribute('href', bookmarklet);
        link.setAttribute('draggable', 'true');
        link.setAttribute('title', 'Drag this link to your bookmarks bar');

        // Also make it possible to click the button on this page (for debug) ‚Äî it will execute right away.
        link.addEventListener('click', function(e) {
          // normal click should open as a link only when ctrl/alt pressed; otherwise prevent navigation
          e.preventDefault();
          // For now, do nothing ‚Äî user should drag to bookmarks bar and run on CA IM pages.
        }, false);
      } catch (err) {
        console.error('Failed to build bookmarklet link', err);
      }
    });
    </script>
</body>
</html>

