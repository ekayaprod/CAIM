<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CA IM Preset Form Filler</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .step { display: none; }
        .step.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .preset-card { background: white; border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1rem; margin-top: 0.75rem; }
        .preset-field { margin-top: 0.75rem; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen">
    <div class="container max-w-5xl mx-auto p-6">
        <header class="mb-8">
            <a href="caim_suite_index.html" class="inline-flex items-center text-slate-600 hover:text-slate-900 mb-4 transition-colors">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                </svg>
                Back to Suite
            </a>
            <h1 class="text-4xl font-bold text-slate-800">Preset Form Filler</h1>
            <p class="text-slate-600 mt-2">Build intelligent form fillers with location and role presets</p>
        </header>

        <main class="bg-white p-8 rounded-2xl shadow-lg">
            <!-- Step 1: Generate Builder -->
            <div id="step1" class="step active">
                <h2 class="text-2xl font-semibold text-slate-800 mb-6 border-b pb-4">
                    <span class="inline-block bg-blue-100 text-blue-800 text-sm font-semibold px-3 py-1 rounded-full mr-2">Phase 1</span>
                    Generate Builder Bookmarklet
                </h2>
                
                <div class="p-6 bg-blue-50 border border-blue-200 rounded-lg mb-6">
                    <h3 class="font-semibold text-blue-900 mb-2">How It Works</h3>
                    <p class="text-blue-800 text-sm leading-relaxed">
                        This creates a <strong>Builder Tool</strong> bookmarklet. Run it on your CA Identity Manager form, click fields to map them as sources (dropdowns) or destinations (target fields), then export your field mappings as JSON.
                    </p>
                </div>

                <div class="text-center py-8">
                    <p class="text-slate-600 mb-4">Drag this bookmarklet to your bookmarks bar:</p>
                    <a href="" id="builder-bookmarklet-link" class="inline-block px-8 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-colors">
                        üîß CA IM Form Builder
                    </a>
                </div>

                <div class="mt-8 p-4 bg-slate-50 border border-slate-200 rounded-lg">
                    <h4 class="font-semibold text-slate-800 mb-2">Next Steps:</h4>
                    <ol class="text-sm text-slate-600 space-y-1 ml-5 list-decimal">
                        <li>Bookmark the link above</li>
                        <li>Navigate to your CA IM form (where you'd fill out user info)</li>
                        <li>Click the bookmarklet to launch the builder</li>
                        <li>Map source fields (dropdown lists) and destination fields (target inputs)</li>
                        <li>Generate and copy the JSON output</li>
                        <li>Return here and proceed to Phase 2</li>
                    </ol>
                </div>

                <div class="mt-8 flex justify-end">
                    <button onclick="app.showStep(2)" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        Proceed to Phase 2 ‚Üí
                    </button>
                </div>
            </div>

            <!-- Step 2: Load Mappings and Build Preset UI -->
            <div id="step2" class="step">
                <h2 class="text-2xl font-semibold text-slate-800 mb-6 border-b pb-4">
                    <span class="inline-block bg-green-100 text-green-800 text-sm font-semibold px-3 py-1 rounded-full mr-2">Phase 2</span>
                    Configure Presets
                </h2>

                <div class="mb-6">
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Field Mappings JSON (from Builder Tool)</label>
                    <textarea id="mappings-json" rows="10" class="w-full px-3 py-2 border border-slate-300 rounded-lg font-mono text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Paste your field mappings JSON here..."></textarea>
                </div>

                <button onclick="app.renderPresetUI()" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors mb-6">
                    Load Mappings & Build Preset UI
                </button>

                <div id="presets-ui-container" style="display: none;">
                    <!-- Defaults Section -->
                    <div id="defaults-container" class="p-6 bg-slate-50 border border-slate-200 rounded-lg mb-6">
                        <h3 class="text-lg font-semibold text-slate-800 mb-4">Default Values</h3>
                        <p class="text-sm text-slate-600 mb-4">These values will be applied to every form fill unless overridden by presets.</p>
                        <div id="defaults-presets"></div>
                    </div>

                    <!-- Locations and Roles -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="text-lg font-semibold text-slate-800 mb-3">Location Presets</h3>
                            <p class="text-sm text-slate-600 mb-3">Configure field values for different locations.</p>
                            <div id="locations-presets"></div>
                            <button onclick="app.addPreset('locations')" class="mt-3 px-4 py-2 border border-slate-300 rounded-lg hover:bg-slate-50 transition-colors text-sm">
                                + Add Location
                            </button>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-slate-800 mb-3">Role Presets</h3>
                            <p class="text-sm text-slate-600 mb-3">Configure field values for different roles.</p>
                            <div id="roles-presets"></div>
                            <button onclick="app.addPreset('roles')" class="mt-3 px-4 py-2 border border-slate-300 rounded-lg hover:bg-slate-50 transition-colors text-sm">
                                + Add Role
                            </button>
                        </div>
                    </div>
                </div>

                <div class="mt-8 flex justify-between">
                    <button onclick="app.showStep(1)" class="px-6 py-2 border border-slate-300 rounded-lg hover:bg-slate-50 transition-colors">
                        ‚Üê Back
                    </button>
                    <button onclick="app.showStep(3)" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        Proceed to Phase 3 ‚Üí
                    </button>
                </div>
            </div>

            <!-- Step 3: Generate Final Bookmarklet -->
            <div id="step3" class="step">
                <h2 class="text-2xl font-semibold text-slate-800 mb-6 border-b pb-4">
                    <span class="inline-block bg-purple-100 text-purple-800 text-sm font-semibold px-3 py-1 rounded-full mr-2">Phase 3</span>
                    Generate Final Bookmarklet
                </h2>

                <div class="p-6 bg-green-50 border border-green-200 rounded-lg text-center mb-6">
                    <h3 class="font-semibold text-green-900 mb-3">Ready to Deploy</h3>
                    <p class="text-green-800 text-sm mb-4">
                        Generate your final form filler bookmarklet with all configured presets. This tool will be used by end-users to quickly fill forms.
                    </p>
                    
                    <input type="text" id="final-bookmarklet-name" placeholder="Enter bookmarklet name (e.g., 'HR Onboarding')" class="w-full max-w-md mx-auto px-4 py-2 border border-slate-300 rounded-lg mb-4 text-center focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    
                    <button onclick="app.generateFinalBookmarklet()" class="px-8 py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition-colors shadow-md">
                        Generate Final Bookmarklet
                    </button>
                </div>

                <div id="final-output" style="display: none;" class="p-6 bg-blue-50 border border-blue-200 rounded-lg text-center">
                    <p class="font-semibold text-blue-900 mb-4">‚úÖ Success! Drag this link to your bookmarks bar:</p>
                    <div id="final-bookmarklet-link-container" class="mb-4"></div>
                    <p class="text-sm text-blue-800">Your end-users can now use this bookmarklet to quickly fill forms with location and role presets.</p>
                </div>

                <div class="mt-8 flex justify-between">
                    <button onclick="app.showStep(2)" class="px-6 py-2 border border-slate-300 rounded-lg hover:bg-slate-50 transition-colors">
                        ‚Üê Back
                    </button>
                    <button onclick="app.showStep(1)" class="px-6 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-700 transition-colors">
                        Start Over
                    </button>
                </div>
            </div>
        </main>
    </div>

    <template id="preset-card-template">
        <div class="preset-card">
            <strong data-name class="text-slate-800"></strong>
            <div data-fields-container></div>
        </div>
    </template>

<script>
const BUILDER_TOOL = {
    generateScript: () => {
        const builderLogic = `const state={panelId:"idm-builder-"+Date.now(),mode:null,currentSource:null,currentDestinations:[],mappings:[]};function cleanup(){const e=document.getElementById(state.panelId);e&&e.remove(),document.body.style.cursor="default",document.removeEventListener("click",clickHandler,!0)}function setMode(e){state.mode=e,document.body.style.cursor="crosshair",document.getElementById(state.panelId+"-mode-display").textContent="Current Mode: "+e}function scrapeSource(e){const t={sourceId:e.id||e.name,sourceOptions:[],sourceValue:null};"SELECT"===e.tagName?t.sourceOptions=Array.from(e.options).map(e=>e.text.trim()).filter(Boolean):t.sourceValue=e.value||"",state.currentSource=t,updateUI()}function scrapeDestination(e){const t={id:e.id||e.name,type:"text",allowMultiple:!!e.multiple,defaultValue:e.value||""};if("SELECT"===e.tagName){const o=e.closest("td, div"),n=o?o.parentElement:e.parentElement;n&&n.querySelector('input[id*="OptionSelectorAdd"], button[id*="add"]')?t.type="duallist":t.type="select"}state.currentDestinations.find(o=>o.id===t.id)||state.currentDestinations.push(t),updateUI()}function commitMapping(){if(!state.currentSource||0===state.currentDestinations.length)return void alert("Please select a source and at least one destination.");const e={...state.currentSource,destinations:state.currentDestinations};state.mappings.push(e),state.currentSource=null,state.currentDestinations=[],state.mode=null,document.body.style.cursor="default",updateUI()}function generateJSON(){const e=JSON.stringify(state.mappings,null,2),t=document.getElementById(state.panelId+"-json-output");t.value=e,t.style.display="block",t.select(),alert("JSON generated. Copy it from the text area.")}function updateUI(){const e=document.getElementById(state.panelId+"-current-source"),t=document.getElementById(state.panelId+"-current-dests"),o=document.getElementById(state.panelId+"-mappings-list");e.innerHTML=state.currentSource?"<strong>Source:</strong> "+state.currentSource.sourceId:"<em>No source selected</em>",t.innerHTML=state.currentDestinations.length>0?"<strong>Destinations:</strong> "+state.currentDestinations.map(function(e){return e.id+" ("+(e.allowMultiple?"multi":"single")+")"}).join(", "):"<em>No destinations selected</em>",o.innerHTML=state.mappings.map(function(e,t){var o=e.destinations?e.destinations.map(function(e){return e.id}).join(", "):"";return'<div style="border-top: 1px solid #eee; padding: 5px 0;"><strong>Mapping '+(t+1)+":</strong> "+e.sourceId+" &rarr; ["+o+"]</div>"}).join(""),document.getElementById(state.panelId+"-mode-display").textContent="Current Mode: "+(state.mode||"none")}function clickHandler(e){if(e.target.closest("#"+state.panelId))return;e.preventDefault(),e.stopPropagation();const t=e.target.closest("input:not([type=hidden]), select, textarea, button");t&&state.mode&&("source"===state.mode?scrapeSource(t):"destination"===state.mode&&scrapeDestination(t),state.mode=null,document.body.style.cursor="default",updateUI())}function buildUI(){if(document.getElementById(state.panelId))return;const e='<div id="'+state.panelId+'" style="position:fixed; top:10px; right:10px; width:400px; background:white; border:1px solid #ccc; border-radius:8px; box-shadow:0 4px 20px rgba(0,0,0,.2); z-index:999999; font-family:sans-serif; color: #333;"><h3 style="margin:0; padding:15px; background:#333; color:white; border-radius:8px 8px 0 0; font-size:16px;">Identity Manager Form Builder</h3><div style="padding:15px; display:flex; flex-direction:column; gap:10px;"><div style="display:flex; gap:10px;"><button id="'+state.panelId+'-source-btn" style="flex:1;">1. Map Source</button><button id="'+state.panelId+'-dest-btn" style="flex:1;">2. Map Destination(s)</button></div><div id="'+state.panelId+'-mode-display" style="text-align:center; font-style:italic; font-size:12px;">Current Mode: none</div><div style="border: 1px solid #eee; padding: 10px; border-radius: 4px;"><div id="'+state.panelId+'-current-source"><em>No source selected</em></div><div id="'+state.panelId+'-current-dests"><em>No destinations selected</em></div></div><button id="'+state.panelId+'-commit-btn" style="background-color: #28a745; color: white;">3. Commit Mapping</button><hr style="border:none; border-top:1px solid #eee;"><h4>Committed Mappings:</h4><div id="'+state.panelId+'-mappings-list" style="max-height:150px; overflow-y:auto; background:#f9f9f9; padding:5px;"></div><button id="'+state.panelId+'-generate-btn" style="background-color: #007bff; color: white;">4. Generate Mappings JSON</button><textarea id="'+state.panelId+'-json-output" style="display:none; height:100px;"></textarea><button id="'+state.panelId+'-close-btn">Close</button></div></div>';document.body.insertAdjacentHTML("beforeend",e),document.getElementById(state.panelId+"-source-btn").onclick=function(){setMode("source")},document.getElementById(state.panelId+"-dest-btn").onclick=function(){setMode("destination")},document.getElementById(state.panelId+"-commit-btn").onclick=commitMapping,document.getElementById(state.panelId+"-generate-btn").onclick=generateJSON,document.getElementById(state.panelId+"-close-btn").onclick=cleanup,document.addEventListener("click",clickHandler,!0)}buildUI();`;
        return 'javascript:(function(){' + encodeURIComponent(builderLogic) + '})()';
    }
};

const app = {
    state: {
        mappings: null,
        presets: { defaults: {}, locations: {}, roles: {} }
    },

    init() {
        const exampleMappings = [
            { 
                sourceId: 'IpamCounties.Options', 
                sourceOptions: ['00:No County', '01:Adams', '02:Allegheny'], 
                destinations: [{ id: 'IpamCounties', type: 'duallist', allowMultiple: true, defaultValue: '' }] 
            },
            { 
                sourceId: 'department_list', 
                sourceOptions: ['IT', 'HR', 'Finance', 'Marketing'], 
                destinations: [{ id: 'department_field', type: 'select', allowMultiple: false, defaultValue: '' }] 
            }
        ];
        document.getElementById('mappings-json').placeholder = 'Paste your field mappings JSON here...\n\nExample format:\n' + JSON.stringify(exampleMappings, null, 2);
        document.getElementById('builder-bookmarklet-link').href = BUILDER_TOOL.generateScript();
    },

    showStep(stepNum) {
        document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
        document.getElementById('step' + stepNum).classList.add('active');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    },

    renderPresetUI() {
        try {
            const jsonText = document.getElementById('mappings-json').value;
            if (!jsonText.trim()) {
                alert('Please paste field mappings JSON first.');
                return;
            }
            
            this.state.mappings = JSON.parse(jsonText);
            if (!this.state.mappings || !Array.isArray(this.state.mappings)) {
                throw new Error("Mappings data is not a valid array.");
            }
            
            this.state.presets = { defaults: {}, locations: {}, roles: {} };
            document.getElementById('locations-presets').innerHTML = '';
            document.getElementById('roles-presets').innerHTML = '';
            
            const defaultsContainer = document.getElementById('defaults-presets');
            defaultsContainer.innerHTML = '';
            let hasDefaults = false;

            this.state.mappings.forEach(mapping => {
                if (!mapping.destinations || !Array.isArray(mapping.destinations)) return;
                mapping.destinations.forEach(dest => {
                    if (dest.type === 'text' && dest.defaultValue) {
                        hasDefaults = true;
                        this.state.presets.defaults[dest.id] = dest.defaultValue;
                        const fieldDiv = document.createElement('div');
                        fieldDiv.className = 'preset-field';
                        fieldDiv.innerHTML = `
                            <label class="block text-sm font-medium text-slate-700 mb-1">${dest.id}</label>
                            <input type="text" value="${dest.defaultValue}" onchange="app.updateDefaultValue('${dest.id}', this.value)" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        `;
                        defaultsContainer.appendChild(fieldDiv);
                    }
                });
            });
            
            document.getElementById('defaults-container').style.display = hasDefaults ? 'block' : 'none';
            document.getElementById('presets-ui-container').style.display = 'block';
            
            alert('Field mappings loaded successfully! You can now add location and role presets.');
        } catch (e) {
            alert('Invalid JSON in Field Mappings: ' + e.message);
        }
    },

    updateDefaultValue(destId, value) {
        this.state.presets.defaults[destId] = value;
    },
    
    addPreset(type) {
        if (!this.state.mappings) { 
            alert('Please load field mappings first.'); 
            return; 
        }
        
        const name = prompt('Enter name for new ' + type.slice(0, -1) + ':');
        if (!name) return;
        
        if (this.state.presets[type] && this.state.presets[type][name]) {
            alert('A preset with this name already exists.');
            return;
        }
        
        if (!this.state.presets[type]) this.state.presets[type] = {};
        this.state.presets[type][name] = {};
        
        const template = document.getElementById('preset-card-template');
        const card = template.content.cloneNode(true);
        const cardElement = card.querySelector('.preset-card');
        const fieldsContainer = card.querySelector('[data-fields-container]');

        card.querySelector('[data-name]').textContent = name;
        cardElement.id = 'preset-' + type + '-' + name.replace(/\s+/g, '-');

        this.state.mappings.forEach(mapping => {
            if (!mapping.destinations || !Array.isArray(mapping.destinations)) return;
            mapping.destinations.forEach(dest => {
                const fieldWrapper = document.createElement('div');
                fieldWrapper.className = 'preset-field';
                
                const label = document.createElement('label');
                label.className = 'block text-sm font-medium text-slate-700 mb-1';
                label.textContent = dest.id + ' (' + (dest.allowMultiple ? 'multi' : 'single') + ')';

                const isMultiple = dest.allowMultiple;
                const select = document.createElement('select');
                select.className = 'w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent';
                select.multiple = isMultiple;
                if (isMultiple) {
                    select.style.height = '100px';
                }
                
                select.onchange = () => {
                    const value = isMultiple ? Array.from(select.selectedOptions).map(o => o.value) : select.value;
                    this.updatePresetValue(type, name, dest.id, value);
                };

                if (!isMultiple) {
                    select.add(new Option('-- Choose Value --', ''));
                }
                
                if (mapping.sourceOptions && mapping.sourceOptions.length > 0) {
                    mapping.sourceOptions.forEach(opt => select.add(new Option(opt, opt)));
                }
                
                fieldWrapper.appendChild(label);
                fieldWrapper.appendChild(select);
                fieldsContainer.appendChild(fieldWrapper);
            });
        });
        
        document.getElementById(type + '-presets').appendChild(card);
    },

    updatePresetValue(type, presetName, destId, value) {
        if (!this.state.presets[type][presetName]) this.state.presets[type][presetName] = {};
        this.state.presets[type][presetName][destId] = value;
    },

    generateFinalBookmarklet() {
       const name = document.getElementById('final-bookmarklet-name').value.trim();
       if (!name) { 
           alert('Please provide a name for the final bookmarklet.'); 
           return; 
       }
       
       if (!this.state.mappings) {
           alert('Please load field mappings first.');
           return;
       }
       
       const finalLogic = `const MAPPINGS=${JSON.stringify(this.state.mappings)};const PRESETS=${JSON.stringify(this.state.presets)};function getElement(e){return document.getElementById(e)||document.getElementsByName(e)[0]}function applyPresets(e){MAPPINGS.forEach(function(t){t.destinations&&Array.isArray(t.destinations)&&t.destinations.forEach(function(o){const n=e[o.id];if(void 0!==n&&""!==n){const e=getElement(o.id);if(e){if("duallist"===o.type){const a=getElement(t.sourceId),s=e.closest("tr, div.row, div.form-group");if(!s)return void console.error("Could not find container for",o.id);const r=s.querySelector('input[id*="OptionSelectorAdd"]:not([id*="AddAll"]), button[id*="add"]');if(!a||!r)return void console.error("Could not find source or add button for",o.id);const d=Array.isArray(n)?n:[n];Array.from(a.options).forEach(e=>{e.selected=d.includes(e.text.trim())}),r.click()}else e.value=n;e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0}))}}})})}function startApp(){const e="_idm_filler_"+Date.now();if(document.getElementById(e))return;const t=Object.keys(PRESETS.locations||{}).map(e=>'<option value="'+e+'">'+e+"</option>").join(""),o=Object.keys(PRESETS.roles||{}).map(e=>'<option value="'+e+'">'+e+"</option>").join(""),n='<div id="'+e+'" style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:99999;background:white;padding:24px;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,0.3);font-family:sans-serif;min-width:320px;color:#333;"><h3 style="margin:0 0 16px;font-size:18px;font-weight:600;color:#1e293b;">Form Filler</h3><div style="margin-bottom:12px;"><label style="display:block;font-size:14px;font-weight:500;margin-bottom:4px;color:#475569;">Location:</label><select id="_idm_loc" style="width:100%;padding:8px 12px;border:1px solid #cbd5e1;border-radius:6px;font-size:14px;">'+t+'</select></div><div style="margin-bottom:16px;"><label style="display:block;font-size:14px;font-weight:500;margin-bottom:4px;color:#475569;">Role:</label><select id="_idm_role" style="width:100%;padding:8px 12px;border:1px solid #cbd5e1;border-radius:6px;font-size:14px;">'+o+'</select></div><div style="display:flex;gap:8px;"><button id="_idm_fill" style="flex:1;background:#2563eb;color:white;padding:10px;border:none;border-radius:6px;font-weight:500;cursor:pointer;">Fill Form</button><button onclick="document.getElementById(\\''+e+"\\').remove()\" style=\"flex:1;background:#94a3b8;color:white;padding:10px;border:none;border-radius:6px;font-weight:500;cursor:pointer;\">Cancel</button></div></div>";document.body.insertAdjacentHTML("beforeend",n),document.getElementById("_idm_fill").onclick=()=>{const t=document.getElementById("_idm_loc").value,o=document.getElementById("_idm_role").value,n={...PRESETS.defaults||{},...PRESETS.locations[t]||{},...PRESETS.roles[o]||{}};applyPresets(n),document.getElementById(e).remove()}}startApp();`;
       
       const minified = finalLogic.replace(/\s+/g, ' ');
       const finalScript = 'javascript:(function(){' + encodeURIComponent(minified) + '})()';
       
       const container = document.getElementById('final-bookmarklet-link-container');
       container.innerHTML = '<a href="' + finalScript.replace(/"/g, '&quot;') + '" class="inline-block px-8 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition-colors">' + this.escapeHtml(name) + '</a>';
       document.getElementById('final-output').style.display = 'block';
    },
    
    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
};

app.init();
</script>
</body>
</html>
