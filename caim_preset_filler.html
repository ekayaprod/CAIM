<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CA IM Preset Form Filler v9.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .step { display: none; }
        .step.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .preset-card { background: white; border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1rem; margin-top: 0.75rem; }
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center;
            align-items: center; z-index: 10000; opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-backdrop.visible { opacity: 1; visibility: visible; }
        .modal-content {
            background: white; padding: 2rem; border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 90%; max-width: 500px;
            transform: scale(0.95); transition: transform 0.3s ease;
        }
        .modal-backdrop.visible .modal-content { transform: scale(1); }
        .group-item {
            background-color: white;
            border: 1px solid #e2e8f0;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: grab;
        }
        .group-item.dragging { opacity: 0.5; background: #f7fafc; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen">
    <div class="container max-w-5xl mx-auto p-6">
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-slate-800">Preset Form Filler</h1>
            <p class="text-slate-600 mt-2">Build intelligent, stateful form fillers</p>
            <nav class="mt-4 flex gap-4">
                <button onclick="app.showStep(3)" class="text-blue-600 hover:underline">Help & Documentation</button>
                <button id="clear-state-button" class="text-red-600 hover:underline">Clear All Data</button>
            </nav>
        </header>

        <main class="bg-white p-8 rounded-2xl shadow-lg">
            <!-- Step 1: Generate Builder -->
            <div id="step1" class="step active">
                <h2 class="text-2xl font-semibold text-slate-800 mb-6 border-b pb-4">
                    <span class="inline-block bg-blue-100 text-blue-800 text-sm font-semibold px-3 py-1 rounded-full mr-2">Phase 1</span>
                    Generate Field Mapping Tool
                </h2>
                <div class="p-6 bg-blue-50 border border-blue-200 rounded-lg mb-6">
                    <p class="text-blue-800 text-sm leading-relaxed">
                        Drag the bookmarklet to your bookmarks bar. The Smart Mapper now visually highlights captured fields in green directly on the page.
                    </p>
                </div>
                <div class="text-center py-8">
                    <a href="" id="builder-bookmarklet-link" class="inline-block px-8 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-colors">
                        üîß Field Mapper Tool
                    </a>
                </div>
                <div class="mt-8 flex justify-end">
                    <button onclick="app.showStep(2)" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        Proceed to Phase 2 ‚Üí
                    </button>
                </div>
            </div>

            <!-- Step 2: Configure Presets & Generate -->
            <div id="step2" class="step">
                <h2 class="text-2xl font-semibold text-slate-800 mb-6 border-b pb-4">
                    <span class="inline-block bg-green-100 text-green-800 text-sm font-semibold px-3 py-1 rounded-full mr-2">Phase 2</span>
                    Configure Presets & Generate
                </h2>
                <div class="mb-6">
                    <label for="mappings-json" class="block text-sm font-semibold text-slate-700 mb-2">1. Field Mappings JSON</label>
                    <textarea id="mappings-json" rows="6" class="w-full px-3 py-2 border border-slate-300 rounded-lg font-mono text-sm" placeholder="Paste your field mappings JSON here..."></textarea>
                </div>
                 <div class="mt-6 flex gap-3 flex-wrap">
                    <button onclick="app.renderPresetUI()" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">2. Load Mappings</button>
                </div>
                <div id="presets-config-section" style="display: none;">
                    <div class="mt-8 p-6 bg-amber-50 border border-amber-200 rounded-lg">
                        <h3 class="text-lg font-semibold text-slate-800 mb-3">3. Import Preset Groups (Excel)</h3>
                        <div class="flex items-end gap-4 flex-wrap">
                            <button onclick="app.downloadXlsxTemplate()" class="px-4 py-2 bg-sky-600 text-white rounded-lg hover:bg-sky-700 transition-colors text-sm">Download Template</button>
                            <div class="flex-grow">
                                 <label for="bulk-file-upload" class="block text-sm font-medium text-slate-700 mb-2">Upload Excel File</label>
                                 <input type="file" id="bulk-file-upload" accept=".xlsx, .xls, .csv" class="w-full px-3 py-2 border border-slate-300 rounded-lg bg-white text-sm">
                            </div>
                            <button onclick="app.handleImportClick()" class="px-6 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 transition-colors">Import Group...</button>
                        </div>
                    </div>
                    <div id="presets-ui-container" class="mt-8">
                        <h3 class="text-lg font-semibold text-slate-800 mb-3">4. Set Group Priority</h3>
                        <p class="text-sm text-slate-600 mb-4">Drag groups to set their merge priority. Groups at the bottom override values from groups above.</p>
                        <div id="preset-groups-container" class="bg-slate-50 p-4 rounded-lg border min-h-[6rem]">
                            <!-- Preset groups will be rendered here -->
                        </div>
                    </div>
                    <div class="mt-8 p-6 bg-purple-50 border border-purple-200 rounded-lg">
                         <h3 class="text-lg font-semibold text-purple-800 mb-2">5. Generate Form Filler</h3>
                        <div class="mb-4">
                            <label for="final-bookmarklet-name" class="block text-sm font-semibold text-slate-700 mb-2">Bookmarklet Name</label>
                            <input type="text" id="final-bookmarklet-name" class="w-full px-3 py-2 border border-slate-300 rounded-lg" value="IM Form Filler">
                        </div>
                        <button onclick="app.generateFinalBookmarklet()" class="w-full px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-semibold">Generate Bookmarklet</button>
                        <div id="final-output" style="display: none;" class="mt-6 text-center">
                            <p class="text-slate-600 mb-4">Drag this to your bookmarks bar:</p>
                            <div id="final-bookmarklet-link-container"></div>
                        </div>
                    </div>
                </div>
                 <div class="mt-8 flex justify-start">
                    <button onclick="app.showStep(1)" class="px-6 py-2 border border-slate-300 rounded-lg hover:bg-slate-50">‚Üê Back</button>
                </div>
            </div>

            <!-- Step 3: Help -->
            <div id="step3" class="step">
                <h2 class="text-2xl font-semibold text-slate-800 mb-6 border-b pb-4">Help & Documentation</h2>
                <div class="prose max-w-none text-slate-700">
                    <h4>Overview</h4>
                    <p>This tool creates a single, powerful "Form Filler" bookmarklet to automate complex forms using hierarchical "Preset Groups".</p>
                    <h4>Phase 1: Field Mapping</h4>
                    <p>Use the "Field Mapper Tool" on your target form. The new Smart Mapper has two main modes:</p>
                     <ul class="list-disc pl-5 mt-2">
                        <li><b>Scan All Simple Fields:</b> This button automatically finds and maps all standard text boxes, text areas, and simple dropdowns. This should be your first step.</li>
                        <li><b>Map Duallist Pair:</b> Activate this mode, then click once anywhere inside a complex duallist field (the two boxes with arrows). The tool will automatically identify both the source and destination lists and map them correctly.</li>
                        <li>As you map fields, they will be highlighted in green on the page for easy tracking.</li>
                    </ul>
                    <h4>Phase 2: Configuration & Generation</h4>
                    <ol>
                        <li><strong>Load Mappings:</strong> Paste the JSON from the mapper tool.</li>
                        <li><strong>Import Preset Groups:</strong> Import Excel files. You'll choose how to handle blank cells:
                            <ul>
                                <li><strong>"Ignore Blanks" (Default):</strong> Empty cells are skipped entirely. The bookmarklet will only touch fields that have values in your Excel. Use this when you want to set specific fields while leaving all others unchanged.</li>
                                <li><strong>"Blanks Mean Clear Field":</strong> Empty cells become clear instructions. Non-empty cells become set instructions. The bookmarklet will clear fields that are blank in Excel and set fields that have values. Use this when you want to clear multiple fields and set a few specific ones.</li>
                            </ul>
                            <strong>Important:</strong> Any text value (including "DELETE", "CLEAR", "REMOVE") will be treated as a real value to set, not a clear marker. Only truly empty cells trigger clearing when using "Blanks Mean Clear Field" mode.
                        </li>
                        <li><strong>Set Hierarchy:</strong> Drag and drop the imported groups to set their merge priority.</li>
                        <li><strong>Generate Bookmarklet:</strong> Create the final "Form Filler" bookmarklet.</li>
                    </ol>
                    <h4>How to Use the Form Filler Bookmarklet (New Stateless Logic)</h4>
                    <p>The generated bookmarklet is now "stateless" and intelligent, making it much more robust against page reloads.</p>
                    <ol>
                        <li><strong>First Click:</strong> Click the bookmarklet. It will prompt you to select your presets.</li>
                        <li>The filler will complete all standard fields first (text boxes, simple dropdowns). Then, it will perform the <strong>first</strong> action that causes a page reload (like a duallist update) and then stop, showing a progress overlay.</li>
                        <li><strong>Subsequent Clicks:</strong> After the page reloads, <strong>simply click the bookmarklet again</strong>. It will silently re-scan the form, see what's left to do, and automatically continue with the next reloading action without prompting you again.</li>
                        <li>Repeat this process until all actions are complete. The process is seamless for resuming tasks.</li>
                    </ol>
                </div>
                <div class="mt-8">
                    <button onclick="app.showStep(1)" class="px-6 py-2 border border-slate-300 rounded-lg hover:bg-slate-50">‚Üê Back to Start</button>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Unified Modal -->
    <div id="app-modal" class="modal-backdrop">
        <div class="modal-content">
            <h3 id="modal-title" class="text-lg font-semibold text-slate-800 mb-4"></h3>
            <div id="modal-text" class="text-slate-700 mb-4 whitespace-pre-wrap"></div>
            <div id="modal-fields"></div>
            <div id="modal-buttons" class="mt-6 text-right space-x-2"></div>
        </div>
    </div>

    <template id="preset-group-template">
        <div class="group-item" draggable="true">
            <div class="flex items-center pl-2">
                <div class="flex flex-col">
                    <strong data-name></strong>
                    <small data-behavior class="text-slate-500 text-xs"></small>
                </div>
            </div>
            <div>
                <button data-action="view" class="text-sm text-blue-600 hover:underline">View</button>
                <button data-action="delete" class="text-sm text-red-600 hover:underline ml-4">&times; Delete</button>
            </div>
        </div>
    </template>

<script>
const app = {
    // STATE
    state: {
        mappings: null,
        mappingsByField: null,
        presets: { defaults: {}, groups: [] },
    },
    ui: {},
    modalResolve: null,
    draggedItem: null,
    STORAGE_KEY: 'caimPresetFillerState_v9',
    CSS: {
        BTN_PRIMARY: 'bg-blue-600 text-white',
        BTN_DANGER: 'bg-red-600 text-white',
        BTN_SUCCESS: 'bg-green-600 text-white',
        INPUT: 'w-full px-3 py-2 border border-slate-300 rounded-lg text-sm',
    },

    // CORE APP LOGIC
    init() {
        this.ui = {
            steps: Array.from({length: 3}, (_, i) => document.getElementById(`step${i+1}`)),
            mappingsJson: document.getElementById('mappings-json'),
            presetsConfigSection: document.getElementById('presets-config-section'),
            presetGroupsContainer: document.getElementById('preset-groups-container'),
            modal: document.getElementById('app-modal'),
            modalTitle: document.getElementById('modal-title'),
            modalText: document.getElementById('modal-text'),
            modalFields: document.getElementById('modal-fields'),
            modalButtons: document.getElementById('modal-buttons'),
            fileInput: document.getElementById('bulk-file-upload'),
            clearStateButton: document.getElementById('clear-state-button'),
        };
        const builderScript = this.BUILDER_TOOL.getMinifiedScript();
        document.getElementById('builder-bookmarklet-link').href = 'javascript:' + encodeURIComponent(builderScript);
        
        if (this.loadState()) {
            if (this.state.mappings) {
                this.ui.mappingsJson.value = JSON.stringify(this.state.mappings, null, 2);
                try { this.renderPresetUI(true); } catch(e) { console.error("Error rendering loaded state:", e); }
            }
        }
        
        this.showStep(1);
        this.addDragDropListeners();
        this.ui.clearStateButton.onclick = () => this.clearState();
    },

    showStep(stepNumber) {
        this.ui.steps.forEach((step, index) => step.classList.toggle('active', index + 1 === stepNumber));
    },

    async renderPresetUI(isFromLoad = false) {
        const task = async () => {
            const jsonInput = this.ui.mappingsJson.value;
            if (!jsonInput) {
                if (!isFromLoad) this.showError('Please paste the mappings JSON first.');
                return;
            }

            if (!isFromLoad && this.state.presets.groups.length > 0) {
                const confirmed = await this.confirmAction(
                    'Loading new mappings will clear all existing preset groups. Are you sure you want to continue?',
                    'Yes, Clear Presets'
                );
                if (!confirmed) return;
                this.state.presets.groups = [];
                this.rerenderGroupsUI();
            }
            
            const newMappings = JSON.parse(jsonInput);

            const seenIds = new Set();
            const duplicates = [];
            for (const m of newMappings) {
                const id = this._fieldId(m);
                if (seenIds.has(id)) {
                    duplicates.push(id);
                }
                seenIds.add(id);
            }

            if (duplicates.length > 0) {
                this.showError(`Your mappings JSON contains duplicate destination IDs, which is not allowed. Please correct the following duplicates:\n\n- ${[...new Set(duplicates)].join('\n- ')}`);
                return;
            }

            this.state.mappings = newMappings;
            this.state.mappingsByField = Object.fromEntries(this.state.mappings.map(m => [this._fieldId(m), m]));
            this.ui.presetsConfigSection.style.display = 'block';
            this.rerenderGroupsUI();
            if (!isFromLoad) this.saveState();
        };

        if (isFromLoad) {
            this.safely(() => { task(); }, 'JSON Parse');
        } else {
            await this.safely(task, 'JSON Parse');
        }
    },
    
    // STATE PERSISTENCE
    saveState() {
        try {
            const stateToSave = { mappings: this.state.mappings, presets: this.state.presets };
            localStorage.setItem(this.STORAGE_KEY, JSON.stringify(stateToSave));
        } catch (e) { console.error("Failed to save state:", e); }
    },

    loadState() {
        try {
            const savedState = localStorage.getItem(this.STORAGE_KEY);
            if (savedState) {
                const parsedState = JSON.parse(savedState);
                this.state.mappings = parsedState.mappings || null;
                this.state.presets = parsedState.presets || { defaults: {}, groups: [] };
                return true;
            }
        } catch (e) {
            console.error("Failed to load state:", e);
            localStorage.removeItem(this.STORAGE_KEY);
        }
        return false;
    },

    async clearState() {
        if (await this.confirmAction('Are you sure you want to clear all mappings and preset groups? This action cannot be undone.')) {
            localStorage.removeItem(this.STORAGE_KEY);
            location.reload();
        }
    },

    // MODAL & UI
    async showModal(config) {
        return new Promise(resolve => {
            this.modalResolve = resolve;
            this.ui.modalTitle.textContent = config.title || '';
            this.ui.modalText.innerHTML = config.message || '';
            this.ui.modalText.style.display = config.message ? 'block' : 'none';
            this.ui.modalFields.innerHTML = config.inputs ? config.inputs.map((input, i) => this._generateModalFieldHtml(i, input)).join('') : '';
            this.ui.modalButtons.innerHTML = (config.buttons || [{ text: 'OK', value: true, class: this.CSS.BTN_PRIMARY }]).map(btn => 
                `<button class="px-6 py-2 rounded-lg ${btn.class || 'bg-slate-200 text-slate-800'}" onclick="app._modalButtonClick(${JSON.stringify(btn.value)}, ${!!config.inputs})">${btn.text}</button>`
            ).join('');
            this.ui.modal.classList.add('visible');
        });
    },

    hideModal(value = null) {
        this.ui.modal.classList.remove('visible');
        if (this.modalResolve) { this.modalResolve(value); this.modalResolve = null; }
    },
    
    _modalButtonClick(value, hasInputs) {
        const results = hasInputs ? Array.from(this.ui.modalFields.querySelectorAll('select, input')).map(el => el.value) : value;
        this.hideModal(results);
    },
    
    _generateModalFieldHtml(index, inputConfig) {
        const inputId = `modal-input-${index}`;
        let html = `<div class="mb-4"><label for="${inputId}" class="block text-sm font-medium text-slate-700 mb-2">${inputConfig.label || 'Input'}</label>`;
        if (inputConfig.type === 'select' && inputConfig.options) {
            html += `<select id="${inputId}" class="${this.CSS.INPUT}">${inputConfig.options.map(opt => `<option value="${opt.value || opt}">${opt.label || opt}</option>`).join('')}</select>`;
        } else {
            html += `<input type="${inputConfig.type || 'text'}" id="${inputId}" placeholder="${inputConfig.placeholder || ''}" value="${inputConfig.value || ''}" class="${this.CSS.INPUT}">`;
        }
        return html + `</div>`;
    },
    
    msg: (title, message) => app.showModal({title: title, message: message}),
    showError: (msg, title = 'Error') => app.msg(title, msg),
    showSuccess: (msg, title = 'Success') => app.msg(title, msg),
    async confirmAction(message, confirmText = 'Confirm') {
        return await this.showModal({ title: 'Confirm Action', message: message.replace(/\n/g, '<br>'), buttons: [{text: 'Cancel', value: false}, {text: confirmText, value: true, class: this.CSS.BTN_PRIMARY}] });
    },

    async safely(fn, errorContext = 'Operation') {
        try { return await fn(); } 
        catch (e) { await this.showError(`${errorContext}: ${e.message}`); return null; }
    },

    // UTILITY HELPERS
    _fieldId: m => m.destinations[0].id,
    escapeHtml: str => String(str || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]),

    // EXCEL & IMPORT
    downloadXlsxTemplate() {
        if (!this.state.mappings) return this.showError('Load mappings first.');
        const headers = ['Name', ...this.state.mappings.map(this._fieldId)];
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet([headers]);
        XLSX.utils.book_append_sheet(wb, ws, 'Presets');
        XLSX.writeFile(wb, 'Preset_Template.xlsx');
    },

    async handleImportClick() {
        if (!this.ui.fileInput.files?.length) return this.showError('Please select a file to import.');
        const reader = new FileReader();
        reader.onload = async (e) => {
            await this.safely(async () => {
                const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const data = XLSX.utils.sheet_to_json(sheet);
                if (data.length === 0) throw new Error('Spreadsheet has no data rows.');
                if (!data[0].Name && !data[0].name) throw new Error('Spreadsheet is missing "Name" column.');
                
                const result = await this.showModal({
                    title: 'Import Preset Group',
                    message: `Importing ${data.length} presets. Give this group a name and choose how to handle blank cells.`,
                    inputs: [ 
                        { label: 'Group Name', placeholder: 'e.g., Locations' },
                        { label: 'Blank Cell Behavior', type: 'select', options: [
                            {value: 'ignore', label: 'Ignore Blanks (Default)'},
                            {value: 'clear', label: 'Blanks Mean "Clear Field"'},
                        ]}
                    ],
                    buttons: [{ text: 'Cancel', value: null }, { text: 'Import', value: 'import', class: 'bg-amber-600 text-white' }]
                });

                if (result && result.length > 0 && result[0]) {
                    const [groupName, blankBehavior] = result;
                    if (this.state.presets.groups.some(g => g.name === groupName)) return this.showError(`A group named "${groupName}" already exists.`);
                    await new Promise(resolve => setTimeout(resolve, 350));
                    this.processImport(groupName, data, blankBehavior === 'clear');
                }
            }, 'File Read');
        };
        reader.readAsArrayBuffer(this.ui.fileInput.files[0]);
    },

    async processImport(groupName, importData, blanksAsClear) {
        this.showModal({ title: 'Importing...', message: `Preparing to import ${importData.length} presets...`, buttons: [] });
        await new Promise(resolve => setTimeout(resolve, 50));

        await this.safely(async () => {
            const groupData = {};

            for (const [i, row] of importData.entries()) {
                const presetName = row.Name || row.name;
                if (!presetName) continue;
                const preset = {};

                for (const fieldId in row) {
                    if (fieldId.toLowerCase() === 'name') continue;
                    const mapping = this.state.mappingsByField[fieldId];
                    if (!mapping) continue;

                    const val = row[fieldId];
                    const isEmpty = (val === null || val === undefined || val === '');

                    if (blanksAsClear) {
                        if (isEmpty) {
                            preset[fieldId] = '';
                        } else {
                            preset[fieldId] = (mapping.format === 'code:description')
                                ? String(val).split(':')[0].trim()
                                : String(val);
                        }
                    } else {
                        if (!isEmpty) {
                            preset[fieldId] = (mapping.format === 'code:description')
                                ? String(val).split(':')[0].trim()
                                : String(val);
                        }
                    }
                }

                groupData[presetName] = preset;

                if (i > 0 && i % 50 === 0) {
                    this.ui.modalText.textContent = `Processing row ${i} of ${importData.length}...`;
                    await new Promise(resolve => setTimeout(resolve, 0));
                }
            }

            this.state.presets.groups.push({ name: groupName, data: groupData, blanksAsClear });
            this.rerenderGroupsUI();
            this.saveState();
            this.ui.fileInput.value = '';

            this.hideModal(); 
            await new Promise(resolve => setTimeout(resolve, 350));
            this.showSuccess(`Group "${groupName}" imported.`);
        }, "Import Processing");
    },

    // PRESET GROUP UI
    rerenderGroupsUI() {
        this.ui.presetGroupsContainer.innerHTML = '';
        if (this.state.presets.groups.length === 0) {
            this.ui.presetGroupsContainer.innerHTML = '<p class="text-slate-500 text-center py-4">No preset groups imported yet.</p>';
            return;
        }
        this.state.presets.groups.forEach((group, index) => {
            const template = document.getElementById('preset-group-template').content.cloneNode(true);
            const groupEl = template.querySelector('.group-item');
            groupEl.dataset.originalIndex = index;
            groupEl.querySelector('[data-name]').textContent = group.name;
            groupEl.querySelector('[data-behavior]').textContent = group.blanksAsClear ? "Blanks clear fields" : "Blanks are ignored";
            groupEl.querySelector('[data-action="view"]').onclick = () => this.viewGroupPresets(index);
            groupEl.querySelector('[data-action="delete"]').onclick = () => this.deleteGroup(index);
            this.ui.presetGroupsContainer.appendChild(groupEl);
        });
    },

    async viewGroupPresets(index) {
        const group = this.state.presets.groups[index];
        if (!group) return;
        let content = `<div class="max-h-96 overflow-y-auto -mx-4 px-4">`;
        Object.entries(group.data).forEach(([presetName, values]) => {
            content += `<div class="preset-card !p-3 !mt-2"><strong class="text-slate-800">${this.escapeHtml(presetName)}</strong><div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-1 mt-2 text-sm">`;
            Object.entries(values).forEach(([field, value]) => {
                content += `<div><span class="font-medium text-slate-600">${this.escapeHtml(field)}:</span> ${this.escapeHtml(value === '' ? '"" (Clear)' : value)}</div>`;
            });
            content += `</div></div>`;
        });
        content += `</div>`;
        await this.showModal({ title: `Presets in "${group.name}"`, message: content });
    },

    async deleteGroup(index) {
        if (await this.confirmAction(`Delete the "${this.state.presets.groups[index]?.name}" group?`)) {
            this.state.presets.groups.splice(index, 1);
            this.rerenderGroupsUI();
            this.saveState();
        }
    },
    
    addDragDropListeners() {
        const container = this.ui.presetGroupsContainer;
        container.addEventListener('dragstart', e => { if(e.target.classList.contains('group-item')) { this.draggedItem = e.target; setTimeout(() => e.target.classList.add('dragging'), 0); } });
        container.addEventListener('dragend', e => { if (this.draggedItem) { this.draggedItem.classList.remove('dragging'); this.draggedItem = null; }});
        container.addEventListener('dragover', e => {
            e.preventDefault();
            const afterElement = this.getDragAfterElement(container, e.clientY);
            const current = document.querySelector('.dragging');
            if (!current) return;
            if (afterElement == null) container.appendChild(current);
            else container.insertBefore(current, afterElement);
        });
        container.addEventListener('drop', e => {
            if (!this.draggedItem) return;
            const newOrder = Array.from(container.querySelectorAll('.group-item')).map(el => this.state.presets.groups[parseInt(el.dataset.originalIndex, 10)]);
            this.state.presets.groups = newOrder;
            this.rerenderGroupsUI();
            this.saveState();
        });
    },

    getDragAfterElement(container, y) {
        const draggable = [...container.querySelectorAll('.group-item:not(.dragging)')];
        return draggable.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            return (offset < 0 && offset > closest.offset) ? { offset, element: child } : closest;
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    },
    
    // BOOKMARKLET GENERATION
    async generateFinalBookmarklet() {
        await this.safely(async () => {
            if (!this.state.mappings) return this.showError('Load mappings first.');
            
            const fieldMeta = {}, lookup = {};
            this.state.mappings.forEach(m => {
                const destId = this._fieldId(m);
                fieldMeta[destId] = { t: m.destinations[0].type, f: m.format || 'text', s: m.sourceId };
                if (m.format === 'code:description' && m.sourceOptions?.length > 0) {
                    lookup[destId] = {};
                    m.sourceOptions.forEach(opt => { 
                        const [code] = opt.split(':'); 
                        if (code?.trim()) lookup[destId][code.trim()] = opt; 
                    });
                }
            });
            
            const completeLogic = this.BOOKMARKLET_UTILITIES + this.FILLER_LOGIC
                .replace('__LOOKUP_DATA__', JSON.stringify(lookup))
                .replace('__FIELDMETA_DATA__', JSON.stringify(fieldMeta))
                .replace('__PRESETS_DATA__', JSON.stringify(this.state.presets));
                
            const name = document.getElementById('final-bookmarklet-name').value.trim();
            if (!name) return this.showError('Please provide a name.');
            
            const minifiedLogic = completeLogic
                .replace(/[\n\r\t]/g, '')
                .replace(/\s*;\s*/g, ";")
                .replace(/\s*:\s*/g, ":")
                .replace(/\s*,\s*/g, ",")
                .replace(/\s*=\s*/g, "=")
                .replace(/\s*{\s*/g, "{")
                .replace(/\s*}\s*/g, "}")
                .replace(/\s*\(\s*/g, "(")
                .replace(/\s*\)\s*/g, ")")
                .replace(/ {2,}/g, ' ')
                .trim();

            const script = 'javascript:' + encodeURIComponent('(function(){' + minifiedLogic + '})()');
            
            document.getElementById('final-bookmarklet-link-container').innerHTML = 
                `<a href="${script.replace(/"/g, '&quot;')}" class="inline-block px-8 py-3 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700">${this.escapeHtml(name)}</a>`;
            document.getElementById('final-output').style.display = 'block';
        });
    },

    BOOKMARKLET_UTILITIES: `function getEl(i){return document.getElementById(i)||document.querySelector(\`select[name="\${i}"],input[name="\${i}"],textarea[name="\${i}"],div[name="\${i}"]\`)}function trigger(e,v){if(!e)return;e.dispatchEvent(new Event(v,{bubbles:true}))}`,
    
    // UPDATED FILLER_LOGIC
    FILLER_LOGIC: `const C={L:__LOOKUP_DATA__,M:__FIELDMETA_DATA__,P:__PRESETS_DATA__,SK:"_caim_fill_s",ID:"_caim_fill_o",SID:"_caim_fill_y"};C.gS=function(){return JSON.parse(sessionStorage.getItem(this.SK)||"null")};C.sS=function(d){sessionStorage.setItem(this.SK,JSON.stringify(d))};C.c=function(){sessionStorage.removeItem(this.SK);const o=document.getElementById(this.ID);if(o)o.remove()};C.render=function(i,v){const m=this.M[i];const val=m.f==="code:description"&&this.L[i]?this.L[i][v]||v:v;return String(val).replace(/\\s+/g,' ').trim()};C.gA=function(e,i){return e.closest("td, div")?.parentElement?.querySelector(\`input[name="action.\${i}.OptionSelectorAdd"]\`)};C.gR=function(e,i){return e.closest("td, div")?.parentElement?.querySelector(\`input[name="action.\${i}.OptionSelectorRemove"]\`)};C.gV=function(e,m){if(!e)return"";if(m.t==="duallist"){if(!e.options.length)return"";return Array.from(e.options).map(o=>o.text.replace(/\\s+/g,' ').trim()).join(",")}return m.t==="select"?e.options[e.selectedIndex]?.text.replace(/\\s+/g,' ').trim()||e.value:e.value};C.sh=function(n){this.c();const t=n===0?"Completing...":n+" more action"+(n===1?"":"s");document.body.insertAdjacentHTML("beforeend",\`<div id="\${this.ID}" style="position:fixed;top:0;left:0;width:100%;height:100%;z-index:100000;background:rgba(0,0,0,0.92);color:#fff;display:flex;flex-direction:column;align-items:center;justify-content:center;font-family:sans-serif;gap:24px;"><div style="font-size:5rem;">‚è≥</div><div style="font-size:2rem;font-weight:700;">\${t}</div><div style="font-size:1.3rem;opacity:0.85;max-width:400px;text-align:center;line-height:1.5;">Click bookmarklet again after page reloads</div></div>\`)};C.pl=function(M){const nD=[],D=[],CLR=[""],sf=['SocialSecurity','SSIPwd','dhsOARSScope1'];for(const f in M){const m=this.M[f],e=getEl(f);if(!m||!e)continue;const p=M[f],ic=CLR.includes(String(p).toUpperCase()),cv=this.gV(e,m);if(ic){if(cv!==""){const a={i:f,c:'clear'};sf.includes(f)?nD.push(a):D.push(a)}}else{const pv=String(p);if(sf.includes(f)){if(this.render(f,pv)!==cv){nD.push({i:f,c:'set',v:pv})}}else{if(m.t==='duallist'){const vs=cv?cv.split(',').map(s=>s.trim()):[],pn=this.render(f,pv).split(':')[0].trim();if(!vs.some(v=>v===pn||v.startsWith(pn+':'))){if(vs.length&&vs[0]!==''){D.push({i:f,c:'clear'})}D.push({i:f,c:'set',v:pv})}}else{if(this.render(f,pv)!==cv){D.push({i:f,c:'set',v:pv})}}}}}return{nD,D}};C.x=function(a){const e=getEl(a.i),m=this.M[a.i];if(!e)return;if(a.c==="clear"){if(m.t==="duallist"){const r=this.gR(e,a.i);if(r&&e.options.length){Array.from(e.options).forEach(o=>o.selected=true);r.click()}}else{e.value="";trigger(e,"input");trigger(e,"change")}}else if(a.c==="set")if(m.t==="duallist"){const sEl=getEl(m.s||a.i+".Options"),btn=this.gA(e,a.i);if(!sEl||!btn)return;const v=this.render(a.i,a.v);Array.from(sEl.options).forEach(o=>{o.selected=o.text.split(':')[0].trim()===v.split(':')[0].trim()});btn.click()}else if(m.t==="select"){const rV=this.render(a.i,a.v),opt=Array.from(e.options).find(o=>o.text.split(':')[0].trim()===rV.split(':')[0].trim());if(opt)e.value=opt.value;else e.value=rV;trigger(e,"change")}else{e.value=this.render(a.i,a.v);trigger(e,"input");trigger(e,"change")}};C.sel=function(){return new Promise(r=>{if(!document.getElementById(this.SID)){const s=\`<style id=\${this.SID}>#_caim_fill_o{--b:#fff;--t:#1f2937;--brd:#d1d5db;--bb:#2563eb;--bt:#fff;--cbg:#fff;--ct:#374151;background:var(--b);color:var(--t);position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:100000;padding:28px;max-width:440px}@media(prefers-color-scheme:dark){#_caim_fill_o{--b:#2d3748;--t:#e2e8f0;--brd:#4a5568;--bb:#3b82f6;--cbg:#4a5568;--ct:#e2e8f0}}.h{margin:0 0 20px;font-size:20px}.l{display:block;font-size:14px;margin-bottom:8px}.s{width:100%;padding:12px;border:2px solid var(--brd);font-size:15px;color:var(--t);background:var(--b)}.bf{display:flex;gap:10px;margin-top:24px}.b{flex:1;padding:12px;font-size:15px;border:none}.ok{background:var(--bb);color:var(--bt)}.can{background:var(--cbg);color:var(--ct);border:2px solid var(--brd)}</style>\`;document.head.insertAdjacentHTML('beforeend',s)}let h=\`<div id="\${this.ID}"><h3 class="h">Select Presets</h3><div style="display:flex;flex-direction:column;gap:14px;">\`;this.P.groups.forEach((g,i)=>{h+=\`<div><label class="l">\${g.name}:</label><select id="_g\${i}" class="s"><option value="">-- Select --</option>\`;Object.keys(g.data).forEach(n=>{h+=\`<option>\${n}</option>\`});h+="</select></div>"});h+=\`</div><div class="bf"><button id="_x" class="b can">Cancel</button><button id="_ok" class="b ok">Continue</button></div></div>\`;document.body.insertAdjacentHTML("beforeend",h);document.getElementById("_x").onclick=()=>this.c();document.getElementById("_ok").onclick=()=>{const d={};this.P.groups.forEach((g,i)=>{const v=document.getElementById(\`_g\${i}\`).value;if(v&&g.data[v])Object.assign(d,g.data[v])});r(d);this.c()}})};const S=C.gS();if(S?.D?.length){const a=S.D.shift();const r=S.D.length;C.sh(r+1);if(r){C.sS({D:S.D})}else{sessionStorage.removeItem(C.SK)}setTimeout(()=>C.x(a),50)}else{C.sel().then(d=>{if(!Object.keys(d).length)return;const{nD,D}=C.pl(d);if(nD.length){nD.forEach(a=>C.x(a))}if(D.length){const a=D.shift();const r=D.length;C.sh(r+1);if(r){C.sS({D:D})}setTimeout(()=>C.x(a),50)}})}`,

    BUILDER_TOOL: {
        getMinifiedScript() { return this.BUILDER_LOGIC.replace(/\s+/g, ' ').trim(); },
        BUILDER_LOGIC: `
            (function(){
                if(document.getElementById('mUI'))return;
                const S={m:[],mode:null,lH:null};
                function gId(e){return e.id||e.name}
                function gEl(i){return document.getElementById(i)||(document.querySelector('select[name="'+i+'"],input[name="'+i+'"],textarea[name="'+i+'"]'))}
                function aF(o){if(!o?.length)return'text';const c=o.filter(p=>!/Enter one|Select one|Almost every/.test(p));if(c.length===0)return'text';if(c.filter(p=>/^\\d+:/.test(p.trim())).length/c.length>0.7)return'code:description';return'text'}
                function add(sId,sO,fmt,dId,dType){if(S.m.find(m=>m.destinations[0].id===dId))return false;S.m.push({sId:sId,sourceOptions:sO,format:fmt,destinations:[{id:dId,type:dType}]});return true}
                function setM(m){S.mode=m;document.body.style.cursor=m?'crosshair':'default';upd()}
                function scan(){let c=0;document.querySelectorAll('input:not([type=hidden]):not([type=submit]):not([type=image]), select:not([name$=".Options"]), textarea').forEach(e=>{const i=gId(e);if(i&&!i.endsWith('.Options')){const t=e.tagName==='SELECT'?'select':'text';if(add(i,[],'text',i,t))c++}});alert('Added '+c+' new simple fields.');upd()}
                function hMO(e){if(!S.mode)return;const t=e.target.closest('input,select,textarea,img');if(!t)return;S.lH=t;t.style.outline='2px solid red'}
                function hMOu(e){if(S.lH)S.lH.style.outline=''}
                function sty(){document.querySelectorAll('[data-caim-mapped]').forEach(e=>{e.style.backgroundColor='';e.style.border='';e.removeAttribute('data-caim-mapped')});S.m.forEach(m=>{const dEl=gEl(m.destinations[0].id);if(dEl){dEl.style.backgroundColor='#e6fffa';dEl.style.border='2px solid #38a169';dEl.setAttribute('data-caim-mapped','true')}})}
                function hC(e){if(!S.mode)return;e.preventDefault();e.stopPropagation();if(S.lH)S.lH.style.outline='';const t=e.target.closest('input,select,textarea,img');if(!t)return;const i=gId(t);if(!i)return alert('Element has no ID or name.');if(S.mode==='simple'){const type=t.tagName==='SELECT'?'select':'text';if(!add(i,[],'text',i,type))alert('Field already mapped.');}else if(S.mode==='duallist'){const p=t.closest('td, div');if(!p)return alert('Could not find duallist parent.');const src=p.parentElement?.querySelector('select[name$=".Options"]'),dest=p.parentElement?.querySelector('select:not([name$=".Options"])');if(!src||!dest)return alert('Could not find source/destination pair.');const sId=gId(src),dId=gId(dest);const sO=Array.from(src.options).map(o=>o.text.trim()).filter(Boolean);const fmt=aF(sO);if(!add(sId,sO,fmt,dId,'duallist'))alert('Field already mapped.');}upd();setM(null)}
                function upd(){const r=document.getElementById('mUI');if(!r)return;const mH=S.m.map((m,i)=>'<div style="padding:4px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;"><span><b>'+(m.sId===m.destinations[0].id?m.sId:m.sId+' &rarr; '+m.destinations[0].id)+'</b></span><button onclick="window._m.rM('+i+')" style="border:none;background:transparent;color:#ef4444;cursor:pointer;">&times;</button></div>').join('')||'<p style="color:#999;text-align:center;padding:10px 0;">No mappings.</p>';r.innerHTML='<div style="background:#2d3748;color:white;padding:12px;font-weight:bold;">Mapper v9.2</div><div style="padding:16px;"><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;"><button onclick="window._m.setM(\\'simple\\')" class="m-btn '+(S.mode==='simple'?'act':'')+'">Map Simple</button><button onclick="window._m.setM(\\'duallist\\')" class="m-btn '+(S.mode==='duallist'?'act':'')+'">Map Duallist</button></div><button onclick="window._m.scan()" class="m-btn" style="width:100%;margin-bottom:10px;background:#38a169;color:white;">Scan All Simple Fields</button><div style="margin-top:12px;border-top:1px solid #e2e8f0;padding-top:8px;"><b>Mappings</b><div style="max-height:200px;overflow-y:auto;border:1px solid #ccc;background:white;margin-top:4px;">'+mH+'</div></div></div><div style="padding:12px;background:#edf2f7;border-top:1px solid #e2e8f0;"><button onclick="window._m.gJ()" class="m-btn" style="background:#dd6b20;color:white;width:100%;font-weight:bold;">Generate & Copy JSON</button><button onclick="window._m.destroy()" style="background:none;border:none;color:#718096;font-size:12px;cursor:pointer;margin-top:4px;width:100%;">Close</button></div><style>.m-btn{padding:8px;border:1px solid #ccc;background:white;border-radius:4px;cursor:pointer;width:100%;}.m-btn.act{background:#3182ce;color:white;}</style>';sty()}
                function gJ(){const j=JSON.stringify(S.m,null,2);navigator.clipboard.writeText(j).then(()=>alert('JSON copied!'),()=>alert('Copy failed'))}
                function rM(i){S.m.splice(i,1);upd()}function destroy(){if(S.lH)S.lH.style.outline='';document.querySelectorAll('[data-caim-mapped]').forEach(e=>{e.style.backgroundColor='';e.style.border='';e.removeAttribute('data-caim-mapped')});document.removeEventListener('mouseover',hMO);document.removeEventListener('mouseout',hMOu);document.removeEventListener('click',hC,true);document.getElementById('mUI').remove()}
                const r=document.createElement('div');r.id='mUI';r.style.cssText='position:fixed;top:20px;right:20px;z-index:10001;width:350px;background:#f7fafc;border:1px solid #ccc;border-radius:8px;box-shadow:0 5px 15px rgba(0,0,0,0.2);font-family:sans-serif;font-size:14px;';document.body.appendChild(r);upd();document.addEventListener('mouseover',hMO);document.addEventListener('mouseout',hMOu);document.addEventListener('click',hC,true);window._m={setM,scan,gJ,rM,destroy};
            })()`
    }
};

document.addEventListener('DOMContentLoaded', () => { window.app = app; app.init(); });
</script>
</body>
</html>
