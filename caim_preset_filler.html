<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CA IM Preset Form Filler</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .step { display: none; }
        .step.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .preset-card { background: white; border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1rem; margin-top: 0.75rem; }
        .preset-field { margin-top: 0.75rem; }
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center;
            align-items: center; z-index: 10000; opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-backdrop.visible { opacity: 1; visibility: visible; }
        .modal-content {
            background: white; padding: 2rem; border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 90%; max-width: 450px;
            transform: scale(0.95); transition: transform 0.3s ease;
        }
        .modal-backdrop.visible .modal-content { transform: scale(1); }
    </style>
</head>
<body class="bg-slate-100 min-h-screen">
    <div class="container max-w-5xl mx-auto p-6">
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-slate-800">Preset Form Filler</h1>
            <p class="text-slate-600 mt-2">Build intelligent form fillers with location and role presets</p>
        </header>

        <main class="bg-white p-8 rounded-2xl shadow-lg">
            <!-- Step 1: Generate Builder -->
            <div id="step1" class="step active">
                <h2 class="text-2xl font-semibold text-slate-800 mb-6 border-b pb-4">
                    <span class="inline-block bg-blue-100 text-blue-800 text-sm font-semibold px-3 py-1 rounded-full mr-2">Phase 1</span>
                    Generate Builder Bookmarklet
                </h2>
                <div class="p-6 bg-blue-50 border border-blue-200 rounded-lg mb-6">
                    <h3 class="font-semibold text-blue-900 mb-2">How It Works</h3>
                    <p class="text-blue-800 text-sm leading-relaxed">
                        This tool helps you map your form fields. Run it on your CA IM form, map each source field (like a dropdown) to its destination field. For multi-select fields, you can mark them to "Add All Options" automatically.
                    </p>
                </div>
                <div class="text-center py-8">
                    <p class="text-slate-600 mb-4">Drag this bookmarklet to your bookmarks bar:</p>
                    <a href="" id="builder-bookmarklet-link" class="inline-block px-8 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-colors">
                        üîß CA IM Form Builder
                    </a>
                </div>
                <div class="mt-8 flex justify-end">
                    <button onclick="app.showStep(2)" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        Proceed to Phase 2 ‚Üí
                    </button>
                </div>
            </div>

            <!-- Step 2: Load Mappings and Build Preset UI -->
            <div id="step2" class="step">
                <h2 class="text-2xl font-semibold text-slate-800 mb-6 border-b pb-4">
                    <span class="inline-block bg-green-100 text-green-800 text-sm font-semibold px-3 py-1 rounded-full mr-2">Phase 2</span>
                    Configure Presets
                </h2>
                <div class="mb-6">
                    <label for="mappings-json" class="block text-sm font-semibold text-slate-700 mb-2">1. Field Mappings JSON (from Builder Tool)</label>
                    <textarea id="mappings-json" rows="8" class="w-full px-3 py-2 border border-slate-300 rounded-lg font-mono text-sm" placeholder="Paste your field mappings JSON here..."></textarea>
                </div>
                <button onclick="app.renderPresetUI()" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors mb-6">
                    2. Load Mappings
                </button>
                <div id="bulk-import-section" style="display: none;" class="mt-6 p-6 bg-amber-50 border border-amber-200 rounded-lg">
                    <h3 class="text-lg font-semibold text-slate-800 mb-3">3. Bulk Import from Spreadsheet</h3>
                    <p class="text-sm text-slate-600 mb-4">Download the Excel template. For each field, you can either select a value from the dropdown or **copy-paste directly from your matrix** (e.g., just the two-digit county number). Then, upload the completed file.</p>
                    <div class="flex items-end gap-4 flex-wrap">
                        <button onclick="app.downloadXlsxTemplate()" class="px-6 py-2 bg-sky-600 text-white rounded-lg hover:bg-sky-700 transition-colors">
                            Download Excel Template
                        </button>
                        <div>
                            <label for="bulk-preset-type" class="block text-sm font-medium text-slate-700 mb-2">Preset Type</label>
                            <select id="bulk-preset-type" class="w-full px-3 py-2 border border-slate-300 rounded-lg bg-white text-sm h-[42px]">
                                <option value="locations">Locations</option>
                                <option value="roles">Roles</option>
                            </select>
                        </div>
                        <div class="flex-grow">
                             <label for="bulk-file-upload" class="block text-sm font-medium text-slate-700 mb-2">Upload Completed Excel File</label>
                             <input type="file" id="bulk-file-upload" accept=".xlsx, .xls, .csv" class="w-full px-3 py-2 border border-slate-300 rounded-lg bg-white text-sm">
                        </div>
                        <button onclick="app.importBulkPresets()" class="px-6 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 transition-colors">
                            Import Presets
                        </button>
                    </div>
                </div>
                <div id="presets-ui-container" style="display: none;">
                    <div id="defaults-container" class="p-6 bg-slate-50 border border-slate-200 rounded-lg my-6">
                        <h3 class="text-lg font-semibold text-slate-800 mb-4">Global Default Values</h3>
                        <p class="text-sm text-slate-600 mb-4">Use this section for fields that are the same for every user (like the text fields you mentioned). These values are applied automatically unless a specific preset overrides them.</p>
                        <div id="defaults-presets" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="text-lg font-semibold text-slate-800 mb-3">Location Presets</h3>
                            <div id="locations-presets"></div>
                            <button onclick="app.addPreset('locations')" class="mt-3 px-4 py-2 border border-slate-300 rounded-lg hover:bg-slate-50 transition-colors text-sm">+ Add Location</button>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-slate-800 mb-3">Role Presets</h3>
                            <div id="roles-presets"></div>
                            <button onclick="app.addPreset('roles')" class="mt-3 px-4 py-2 border border-slate-300 rounded-lg hover:bg-slate-50 transition-colors text-sm">+ Add Role</button>
                        </div>
                    </div>
                </div>
                <div class="mt-8 flex justify-between">
                    <button onclick="app.showStep(1)" class="px-6 py-2 border border-slate-300 rounded-lg hover:bg-slate-50">‚Üê Back</button>
                    <button onclick="app.showStep(3)" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Proceed to Phase 3 ‚Üí</button>
                </div>
            </div>

            <!-- Step 3: Generate Final Bookmarklet -->
            <div id="step3" class="step">
                <h2 class="text-2xl font-semibold text-slate-800 mb-6 border-b pb-4">
                    <span class="inline-block bg-purple-100 text-purple-800 text-sm font-semibold px-3 py-1 rounded-full mr-2">Phase 3</span>
                    Generate Final Bookmarklet
                </h2>
                <div class="p-6 bg-green-50 border border-green-200 rounded-lg text-center mb-6">
                    <h3 class="font-semibold text-green-900 mb-3">Ready to Deploy</h3>
                    <p class="text-green-800 text-sm mb-4">Generate your final form filler bookmarklet with all configured presets.</p>
                    <input type="text" id="final-bookmarklet-name" placeholder="Enter bookmarklet name (e.g., 'HR Onboarding')" class="w-full max-w-md mx-auto px-4 py-2 border border-slate-300 rounded-lg mb-4 text-center">
                    <button onclick="app.generateFinalBookmarklet()" class="px-8 py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 shadow-md">
                        Generate Final Bookmarklet
                    </button>
                </div>
                <div id="final-output" style="display: none;" class="p-6 bg-blue-50 border border-blue-200 rounded-lg text-center">
                    <p class="font-semibold text-blue-900 mb-4">‚úÖ Success! Drag this link to your bookmarks bar:</p>
                    <div id="final-bookmarklet-link-container" class="mb-4"></div>
                </div>
                <div class="mt-8 flex justify-between">
                    <button onclick="app.showStep(2)" class="px-6 py-2 border border-slate-300 rounded-lg hover:bg-slate-50">‚Üê Back</button>
                    <button onclick="app.showStep(1)" class="px-6 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-700">Start Over</button>
                </div>
            </div>
        </main>
    </div>
    
    <div id="custom-modal" class="modal-backdrop">
        <div class="modal-content">
            <p id="modal-message" class="text-slate-600 mb-6">This is a modal message.</p>
            <div id="modal-buttons" class="flex justify-end gap-3">
                <button id="modal-confirm" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">OK</button>
            </div>
        </div>
    </div>

    <template id="preset-card-template">
        <div class="preset-card">
            <strong data-name class="text-slate-800"></strong>
            <div data-fields-container></div>
        </div>
    </template>

<script>
const BUILDER_TOOL = {
    generateScript: () => {
        const builderLogic = ''
            + 'const state = {'
            + '    panelId: "idm-builder-" + Date.now(),'
            + '    mode: null,'
            + '    currentSource: null,'
            + '    currentDestination: null,'
            + '    mappings: []'
            + '};'
            + ''
            + 'function cleanup() {'
            + '    const panel = document.getElementById(state.panelId);'
            + '    if (panel) panel.remove();'
            + '    document.body.style.cursor = "default";'
            + '    document.removeEventListener("click", clickHandler, true);'
            + '}'
            + ''
            + 'function setMode(mode) {'
            + '    state.mode = mode;'
            + '    document.body.style.cursor = "crosshair";'
            + '    document.getElementById(state.panelId + "-mode-display").textContent = "Current Mode: " + mode;'
            + '}'
            + '            '
            + 'function toggleAddAll(destId) {'
            + '    if(state.currentDestination && state.currentDestination.id === destId) {'
            + '        state.currentDestination.addAll = !state.currentDestination.addAll;'
            + '        updateUI();'
            + '    }'
            + '}'
            + 'window.toggleAddAll = toggleAddAll;'
            + ''
            + 'function scrapeSource(el) {'
            + '    const source = {'
            + '        sourceId: el.id || el.name,'
            + '        sourceOptions: []'
            + '    };'
            + '    if (el.tagName === \'SELECT\') {'
            + '        source.sourceOptions = Array.from(el.options).map(opt => opt.text.trim()).filter(Boolean);'
            + '    }'
            + '    state.currentSource = source;'
            + '    updateUI();'
            + '}'
            + ''
            + 'function scrapeDestination(el) {'
            + '    const dest = {'
            + '        id: el.id || el.name,'
            + '        type: \'text\','
            + '        defaultValue: el.value || \'\','
            + '        addAll: false'
            + '    };'
            + '    if (el.tagName === \'SELECT\') {'
            + '        const container = el.closest(\'td, div\');'
            + '        const parent = container ? container.parentElement : el.parentElement;'
            + '        if (parent && parent.querySelector(\'input[id*="OptionSelectorAdd"], button[id*="add"]\')) {'
            + '            dest.type = \'duallist\';'
            + '        } else {'
            + '            dest.type = \'select\';'
            + '        }'
            + '    }'
            + '    state.currentDestination = dest;'
            + '    updateUI();'
            + '}'
            + ''
            + 'function commitMapping() {'
            + '    if (!state.currentSource || !state.currentDestination) {'
            + '        alert("Please select one source and one destination.");'
            + '        return;'
            + '    }'
            + '    const mapping = {'
            + '        ...state.currentSource,'
            + '        destinations: [state.currentDestination]'
            + '    };'
            + '    state.mappings.push(mapping);'
            + '    state.currentSource = null;'
            + '    state.currentDestination = null;'
            + '    state.mode = null;'
            + '    document.body.style.cursor = "default";'
            + '    updateUI();'
            + '}'
            + ''
            + 'function generateJSON() {'
            + '    const json = JSON.stringify(state.mappings, null, 2);'
            + '    const textarea = document.getElementById(state.panelId + "-json-output");'
            + '    textarea.value = json;'
            + '    textarea.style.display = "block";'
            + '    textarea.select();'
            + '    alert("JSON generated. Copy it from the text area.");'
            + '}'
            + ''
            + 'function updateUI() {'
            + '    const sourceEl = document.getElementById(state.panelId + "-current-source");'
            + '    const destEl = document.getElementById(state.panelId + "-current-dest");'
            + '    const mappingsEl = document.getElementById(state.panelId + "-mappings-list");'
            + ''
            + '    sourceEl.innerHTML = state.currentSource ? `<strong>Source:</strong> ${state.currentSource.sourceId}` : \'<em>No source selected</em>\';'
            + '    if(state.currentDestination) {'
            + '        let addAllCheckbox = \'\';'
            + '        if(state.currentDestination.type === \'duallist\') {'
            + '             addAllCheckbox = `<label style="margin-left: 10px; font-size: 12px;"><input type="checkbox" onchange="toggleAddAll(\'${state.currentDestination.id}\')" ${state.currentDestination.addAll ? \'checked\' : \'\'}> Add All Options</label>`;'
            + '        }'
            + '        destEl.innerHTML = `<strong>Destination:</strong> ${state.currentDestination.id} ${addAllCheckbox}`;'
            + '    } else {'
            + '        destEl.innerHTML = \'<em>No destination selected</em>\';'
            + '    }'
            + ''
            + '    mappingsEl.innerHTML = state.mappings.map((m, i) => {'
            + '        const dest = m.destinations[0];'
            + '        const addAllText = dest.addAll ? \' (Add All)\' : \'\';'
            + '        return `<div style="border-top: 1px solid #eee; padding: 5px 0;"><strong>Mapping ${i + 1}:</strong> ${m.sourceId} &rarr; ${dest.id}${addAllText}</div>`;'
            + '    }).join(\'\');'
            + '    document.getElementById(state.panelId + "-mode-display").textContent = "Current Mode: " + (state.mode || "none");'
            + '}'
            + ''
            + 'function clickHandler(event) {'
            + '    if (event.target.closest("#" + state.panelId)) return;'
            + '    event.preventDefault();'
            + '    event.stopPropagation();'
            + '    const targetEl = event.target.closest("input:not([type=hidden]), select, textarea, button");'
            + '    if (targetEl && state.mode) {'
            + '        if (state.mode === \'source\') scrapeSource(targetEl);'
            + '        if (state.mode === \'destination\') scrapeDestination(targetEl);'
            + '        state.mode = null;'
            + '        document.body.style.cursor = "default";'
            + '        updateUI();'
            + '    }'
            + '}'
            + ''
            + 'function buildUI() {'
            + '    if (document.getElementById(state.panelId)) return;'
            + '    const uiHTML = `'
            + '        <div id="${state.panelId}" style="position:fixed; top:10px; right:10px; width:400px; background:white; border:1px solid #ccc; border-radius:8px; box-shadow:0 4px 20px rgba(0,0,0,.2); z-index:999999; font-family:sans-serif; color: #333;">'
            + '            <h3 style="margin:0; padding:15px; background:#333; color:white; border-radius:8px 8px 0 0; font-size:16px;">Identity Manager Form Builder</h3>'
            + '            <div style="padding:15px; display:flex; flex-direction:column; gap:10px;">'
            + '                <div style="display:flex; gap:10px;">'
            + '                    <button id="${state.panelId}-source-btn" style="flex:1;">1. Map Source</button>'
            + '                    <button id="${state.panelId}-dest-btn" style="flex:1;">2. Map Destination</button>'
            + '                </div>'
            + '                <div id="${state.panelId}-mode-display" style="text-align:center; font-style:italic; font-size:12px;">Current Mode: none</div>'
            + '                <div style="border: 1px solid #eee; padding: 10px; border-radius: 4px;">'
            + '                    <div id="${state.panelId}-current-source"><em>No source selected</em></div>'
            + '                    <div id="${state.panelId}-current-dest"><em>No destination selected</em></div>'
            + '                </div>'
            + '                <button id="${state.panelId}-commit-btn" style="background-color: #28a745; color: white;">3. Commit Mapping</button>'
            + '                <hr style="border:none; border-top:1px solid #eee;">'
            + '                <h4>Committed Mappings:</h4>'
            + '                <div id="${state.panelId}-mappings-list" style="max-height:150px; overflow-y:auto; background:#f9f9f9; padding:5px;"></div>'
            + '                <button id="${state.panelId}-generate-btn" style="background-color: #007bff; color: white;">4. Generate Mappings JSON</button>'
            + '                <textarea id="${state.panelId}-json-output" style="display:none; height:100px;"></textarea>'
            + '                <button id="${state.panelId}-close-btn">Close</button>'
            + '            </div>'
            + '        </div>`;'
            + '    document.body.insertAdjacentHTML("beforeend", uiHTML);'
            + '    document.getElementById(state.panelId + "-source-btn").onclick = () => setMode(\'source\');'
            + '    document.getElementById(state.panelId + "-dest-btn").onclick = () => setMode(\'destination\');'
            + '    document.getElementById(state.panelId + "-commit-btn").onclick = commitMapping;'
            + '    document.getElementById(state.panelId + "-generate-btn").onclick = generateJSON;'
            + '    document.getElementById(state.panelId + "-close-btn").onclick = cleanup;'
            + '    document.addEventListener("click", clickHandler, true);'
            + '}'
            + 'buildUI();';
        return 'javascript:(function(){' + encodeURIComponent(builderLogic) + '})()';
    }
};

const app = {
    state: { mappings: null, presets: { defaults: {}, locations: {}, roles: {} } },
    modal: { el: null, message: null, confirmBtn: null },

    init() {
        this.modal.el = document.getElementById('custom-modal');
        this.modal.message = document.getElementById('modal-message');
        this.modal.confirmBtn = document.getElementById('modal-confirm');
        this.modal.el.addEventListener('click', (e) => { if (e.target === this.modal.el) this.hideModal(); });
        this.modal.confirmBtn.addEventListener('click', () => this.hideModal());
        document.getElementById('builder-bookmarklet-link').href = BUILDER_TOOL.generateScript();
    },
    
    showModal(message) {
        this.modal.message.textContent = message;
        this.modal.el.classList.add('visible');
    },

    hideModal() { this.modal.el.classList.remove('visible'); },
    showStep(stepNum) {
        document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
        document.getElementById('step' + stepNum).classList.add('active');
    },

    renderPresetUI() {
        try {
            const jsonText = document.getElementById('mappings-json').value;
            if (!jsonText.trim()) return this.showModal('Please paste field mappings JSON first.');
            
            this.state.mappings = JSON.parse(jsonText);
            if (!Array.isArray(this.state.mappings)) throw new Error("Mappings data is not a valid array.");
            
            this.state.presets = { defaults: {}, locations: {}, roles: {} };
            ['locations-presets', 'roles-presets', 'defaults-presets'].forEach(id => document.getElementById(id).innerHTML = '');
            
            const defaultsContainer = document.getElementById('defaults-presets');
            let hasDefaults = false;
            this.state.mappings.forEach(mapping => {
                if (!mapping.destinations || !Array.isArray(mapping.destinations)) return;
                mapping.destinations.forEach(dest => {
                    if (dest.type === 'text') {
                        hasDefaults = true;
                        this.state.presets.defaults[dest.id] = dest.defaultValue;
                        const fieldDiv = document.createElement('div');
                        fieldDiv.className = 'preset-field';
                        fieldDiv.innerHTML = `<label class="block text-sm font-medium text-slate-700 mb-1">${dest.id}</label>
                            <input type="text" value="${dest.defaultValue}" onchange="app.updateDefaultValue('${dest.id}', this.value)" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm"> `;
                        defaultsContainer.appendChild(fieldDiv);
                    }
                });
            });
            
            document.getElementById('defaults-container').style.display = hasDefaults ? 'block' : 'none';
            document.getElementById('presets-ui-container').style.display = 'block';
            document.getElementById('bulk-import-section').style.display = 'block';
            this.showModal('Field mappings loaded! You can now download the Excel template or add presets manually.');
        } catch (e) {
            this.showModal('Invalid JSON in Field Mappings: ' + e.message);
        }
    },
    
    downloadXlsxTemplate() {
        if (!this.state.mappings) return this.showModal('Please load mappings first.');

        const wb = XLSX.utils.book_new();
        const mainSheetName = 'Presets';
        
        const headers = ['Name'];
        const dropdownMappings = new Map();

        this.state.mappings.forEach(m => {
            const dest = m.destinations[0];
            if (dest.addAll || dest.type === 'text') return;
            headers.push(dest.id);
            if (m.sourceOptions && m.sourceOptions.length > 0) {
                dropdownMappings.set(dest.id, m.sourceOptions);
            }
        });
        
        const ws = XLSX.utils.aoa_to_sheet([headers]);
        ws['!dataValidation'] = [];
        
        let colIndex = 1;
        dropdownMappings.forEach((options, header) => {
            const listSheetName = `list_${header.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 25)}`;
            const listWs = XLSX.utils.aoa_to_sheet(options.map(o => [o]));
            XLSX.utils.book_append_sheet(wb, listWs, listSheetName);
            // wb.Sheets[listSheetName].Hidden = 1; // This is incorrect and was causing the bug.

            const range = XLSX.utils.encode_range({s: {c: colIndex, r: 1}, e: {c: colIndex, r: 1000}});
            ws['!dataValidation'].push({ 
                sqref: range, 
                validation: { 
                    type: "list", allowBlank: true, showDropDown: true, 
                    formula1: `'${listSheetName}'!$A$1:$A$${options.length}`,
                    showErrorMessage: true, errorStyle: 'warning', errorTitle: 'Pasted value not in list',
                    error: 'This is a warning. The value will be accepted, and the tool will try to find a partial match on the form.'
                }
            });
            colIndex++;
        });

        XLSX.utils.book_append_sheet(wb, ws, mainSheetName);
        XLSX.writeFile(wb, "preset_template.xlsx");
    },

    importBulkPresets() {
        if (!this.state.mappings) return this.showModal('Load mappings first.');
        const fileInput = document.getElementById('bulk-file-upload');
        if (!fileInput.files.length) return this.showModal('Please select a file.');
        
        const presetType = document.getElementById('bulk-preset-type').value;

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(worksheet, {defval:""});

                if (json.length === 0) return this.showModal('Spreadsheet is empty.');

                document.getElementById(presetType + '-presets').innerHTML = '';
                this.state.presets[presetType] = {};

                let importedCount = 0;
                json.forEach(row => {
                    const presetName = row.Name || row.name;
                    if (!presetName) return;
                    
                    if (!this.state.presets[presetType][presetName]) {
                        this.state.presets[presetType][presetName] = {};
                    }
                    
                    for (const key in row) {
                        if (key.toLowerCase() !== 'name') {
                            this.state.presets[presetType][presetName][key] = row[key];
                        }
                    }
                    this.createPresetCard(presetType, presetName, this.state.presets[presetType][presetName]);
                    importedCount++;
                });
                this.showModal(`Successfully imported ${importedCount} ${presetType}.`);

            } catch (error) { this.showModal('Error reading file: ' + error.message); }
        };
        reader.readAsArrayBuffer(fileInput.files[0]);
    },
    
    createPresetCard(type, name, values) {
        const existingCard = document.getElementById('preset-' + type + '-' + name.replace(/\s+/g, '-'));
        if(existingCard) existingCard.remove();
        
        const template = document.getElementById('preset-card-template').content.cloneNode(true);
        const cardElement = template.querySelector('.preset-card');
        cardElement.id = 'preset-' + type + '-' + name.replace(/\s+/g, '-');
        template.querySelector('[data-name]').textContent = name;
        const fieldsContainer = template.querySelector('[data-fields-container]');

        this.state.mappings.forEach(m => {
            const dest = m.destinations[0];
            if (dest.type === 'text') return;
            
            const fieldWrapper = document.createElement('div');
            fieldWrapper.className = 'preset-field';
            let fieldHTML = `<label class="block text-sm font-medium text-slate-700 mb-1">${dest.id}</label>`;

            if (dest.addAll) {
                fieldHTML += `<div class="p-2 bg-slate-100 rounded text-sm text-slate-500">All source options will be applied.</div>`;
            } else {
                const select = document.createElement('select');
                select.className = 'w-full px-3 py-2 border border-slate-300 rounded-lg text-sm';
                select.onchange = () => this.updatePresetValue(type, name, dest.id, select.value);
                select.add(new Option('-- Choose Value --', ''));
                m.sourceOptions.forEach(opt => {
                    const option = new Option(opt, opt);
                    if (values[dest.id] == opt) option.selected = true; 
                    select.add(option);
                });
                fieldWrapper.innerHTML = fieldHTML;
                fieldWrapper.appendChild(select);
            }
             if (!fieldWrapper.querySelector('select')) fieldWrapper.innerHTML = fieldHTML;

            fieldsContainer.appendChild(fieldWrapper);
        });
        document.getElementById(type + '-presets').appendChild(template);
    },

    updateDefaultValue(destId, value) { this.state.presets.defaults[destId] = value; },
    addPreset(type) {
        if (!this.state.mappings) return this.showModal('Load mappings first.');
        const name = prompt('Enter name for new ' + type.slice(0, -1) + ':');
        if (!name || !name.trim()) return;
        if (this.state.presets[type]?.[name]) return this.showModal('Preset name already exists.');
        
        if (!this.state.presets[type]) this.state.presets[type] = {};
        this.state.presets[type][name] = {};
        this.createPresetCard(type, name, {});
    },

    updatePresetValue(type, presetName, destId, value) {
        if (!this.state.presets[type][presetName]) this.state.presets[type][presetName] = {};
        if (!value) delete this.state.presets[type][presetName][destId];
        else this.state.presets[type][presetName][destId] = value;
    },

    generateFinalBookmarklet() {
       const name = document.getElementById('final-bookmarklet-name').value.trim();
       if (!name) return this.showModal('Please provide a name for the bookmarklet.');
       if (!this.state.mappings) return this.showModal('Load mappings first.');

       // --- COMPRESSION LOGIC START ---
       const lookup = {};
       const compressedMappings = this.state.mappings.map(m => {
           const dest = m.destinations[0];
           lookup[dest.id] = {};
           m.sourceOptions.forEach(opt => {
               const [code] = opt.split(':');
               if (code && !isNaN(code)) {
                   lookup[dest.id][code.trim()] = opt;
               } else {
                   lookup[dest.id][opt] = opt;
               }
           });
           return { s: m.sourceId, d: dest.id, t: dest.type, a: dest.addAll };
       });

       const compressedPresets = { defaults: this.state.presets.defaults };
       ['locations', 'roles'].forEach(type => {
           compressedPresets[type] = {};
           for (const presetName in this.state.presets[type]) {
               const preset = this.state.presets[type][presetName];
               const compressedPreset = {};
               for (const fieldId in preset) {
                   const val = String(preset[fieldId]);
                   const [code] = val.split(':');
                   if (code && !isNaN(code)) {
                       compressedPreset[fieldId] = code.trim();
                   } else {
                       compressedPreset[fieldId] = val;
                   }
               }
               compressedPresets[type][presetName] = compressedPreset;
           }
       });
       // --- COMPRESSION LOGIC END ---
       
       const finalLogic = 'const L=' + JSON.stringify(lookup) + ';const M=' + JSON.stringify(compressedMappings) + ';const P=' + JSON.stringify(compressedPresets) + ';function getEl(e){return document.getElementById(e)||document.getElementsByName(e)[0]}function apply(vals){M.forEach(m=>{const v=vals[m.d];if(typeof v==="undefined")return;const el=getEl(m.d);if(!el)return;const findFullOpt=(sel,val)=>{const tVal=String(val).trim();if(L[m.d]&&L[m.d][tVal])return L[m.d][tVal];const opts=Array.from(sel.options);let f=opts.find(o=>o.text.trim()===tVal);if(f)return f.text.trim();f=opts.find(o=>o.text.trim().startsWith(tVal));if(f)return f.text.trim();return val;};if(m.t==="duallist"){const srcEl=getEl(m.s);const addBtn=el.closest("td,div")?.parentElement?.querySelector("input[id*=\\"OptionSelectorAdd\\"],button[id*=\\"add\\"]");if(!srcEl||!addBtn)return;let valsToProc=m.a?Object.values(L[m.d]):(Array.isArray(v)?v:String(v).split(",").map(s=>s.trim()));const resolved=valsToProc.map(val=>findFullOpt(srcEl,val));Array.from(srcEl.options).forEach(opt=>{opt.selected=resolved.includes(opt.text.trim())});addBtn.click()}else if(m.t==="select"){el.value=findFullOpt(el,v)}else{el.value=v};["input","change"].forEach(ev=>el.dispatchEvent(new Event(ev,{bubbles:!0})))})}function start(){const id="_filler_"+Date.now();if(document.getElementById(id))return;const locHTML=Object.keys(P.locations||{}).map(e=>"<option value=\\""+e+"\\">"+e+"</option>").join("");const roleHTML=Object.keys(P.roles||{}).map(e=>"<option value=\\""+e+"\\">"+e+"</option>").join("");const H="<div id=\\""+id+"\\" style=\\"position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:99999;background:white;padding:24px;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,0.3);font-family:sans-serif;min-width:320px;\\"><h3 style=\\"margin:0 0 16px;\\">Form Filler</h3><div><label>Location:</label><select id=\\"_loc\\"><option value=\\"\\">-- Select --</option>"+locHTML+"</select></div><div><label>Role:</label><select id=\\"_role\\"><option value=\\"\\">-- Select --</option>"+roleHTML+"</select></div><button id=\\"_fill\\">Fill</button><button onclick=\\"document.getElementById(\'"+id+"\').remove()\\">Cancel</button></div>";document.body.insertAdjacentHTML("beforeend",H);document.getElementById("_fill").onclick=()=>{const l=document.getElementById("_loc").value;const r=document.getElementById("_role").value;const V={...P.defaults||{},...P.locations[l]||{},...P.roles[r]||{}};apply(V);document.getElementById(id).remove()}}start();';
       
       const finalScript = 'javascript:(function(){' + encodeURIComponent(finalLogic.replace(/\s+/g, ' ').trim()) + '})()';
       
       const container = document.getElementById('final-bookmarklet-link-container');
       container.innerHTML = '<a href="' + finalScript.replace(/"/g, '&quot;') + '" class="inline-block px-8 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700">' + this.escapeHtml(name) + '</a>';
       document.getElementById('final-output').style.display = 'block';
    },
    
    escapeHtml: (text) => {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
};

document.addEventListener('DOMContentLoaded', () => app.init());
</script>
</body>
</html>

