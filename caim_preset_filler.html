<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CA IM Preset Form Filler v5.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .step { display: none; }
        .step.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .preset-card { background: white; border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1rem; margin-top: 0.75rem; }
        .preset-field { margin-top: 0.75rem; }
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center;
            align-items: center; z-index: 10000; opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-backdrop.visible { opacity: 1; visibility: visible; }
        .modal-content {
            background: white; padding: 2rem; border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 90%; max-width: 500px;
            transform: scale(0.95); transition: transform 0.3s ease;
        }
        .modal-backdrop.visible .modal-content { transform: scale(1); }
        .group-item {
            background-color: white;
            border: 1px solid #e2e8f0;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: grab;
        }
        .group-item.dragging {
            opacity: 0.5;
            background: #f7fafc;
        }
    </style>
</head>
<body class="bg-slate-100 min-h-screen">
    <div class="container max-w-5xl mx-auto p-6">
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-slate-800">Preset Form Filler</h1>
            <p class="text-slate-600 mt-2">Build intelligent form fillers with hierarchical preset groups</p>
            <nav class="mt-4">
                <button onclick="app.showStep(4)" class="text-blue-600 hover:underline">Help & Documentation</button>
            </nav>
        </header>

        <main class="bg-white p-8 rounded-2xl shadow-lg">
            <!-- Step 1: Generate Builder -->
            <div id="step1" class="step active">
                <h2 class="text-2xl font-semibold text-slate-800 mb-6 border-b pb-4">
                    <span class="inline-block bg-blue-100 text-blue-800 text-sm font-semibold px-3 py-1 rounded-full mr-2">Phase 1</span>
                    Generate Field Mapping Tool
                </h2>
                <div class="p-6 bg-blue-50 border border-blue-200 rounded-lg mb-6">
                    <h3 class="font-semibold text-blue-900 mb-2">How It Works</h3>
                    <p class="text-blue-800 text-sm leading-relaxed">
                        This tool helps you map your form fields. Run it on your CA IM form, then click on a source field (like a dropdown) and a destination field to create a mapping. The builder automatically detects the format of each field.
                    </p>
                </div>
                <div class="text-center py-8">
                    <p class="text-slate-600 mb-4">Drag this bookmarklet to your bookmarks bar:</p>
                    <a href="" id="builder-bookmarklet-link" class="inline-block px-8 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-colors">
                        üîß Field Mapper Tool v5.0
                    </a>
                </div>
                <div class="mt-8 flex justify-end">
                    <button onclick="app.showStep(2)" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        Proceed to Phase 2 ‚Üí
                    </button>
                </div>
            </div>

            <!-- Step 2: Load Mappings and Build Preset UI -->
            <div id="step2" class="step">
                <h2 class="text-2xl font-semibold text-slate-800 mb-6 border-b pb-4">
                    <span class="inline-block bg-green-100 text-green-800 text-sm font-semibold px-3 py-1 rounded-full mr-2">Phase 2</span>
                    Configure Presets
                </h2>
                <div class="mb-6">
                    <label for="mappings-json" class="block text-sm font-semibold text-slate-700 mb-2">1. Field Mappings JSON (from Builder Tool)</label>
                    <textarea id="mappings-json" rows="8" class="w-full px-3 py-2 border border-slate-300 rounded-lg font-mono text-sm" placeholder="Paste your field mappings JSON here..."></textarea>
                </div>
                 <div class="mt-6 flex gap-3 flex-wrap">
                    <button onclick="app.renderPresetUI()" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">2. Load Mappings</button>
                </div>
                <div id="presets-config-section" style="display: none;">
                    <div class="mt-6 p-6 bg-amber-50 border border-amber-200 rounded-lg">
                        <h3 class="text-lg font-semibold text-slate-800 mb-3">3. Import Preset Groups</h3>
                        <div class="flex items-end gap-4 flex-wrap">
                            <button onclick="app.downloadXlsxTemplate()" class="px-6 py-2 bg-sky-600 text-white rounded-lg hover:bg-sky-700 transition-colors">Download Template</button>
                            <div class="flex-grow">
                                 <label for="bulk-file-upload" class="block text-sm font-medium text-slate-700 mb-2">Upload Completed Excel File</label>
                                 <input type="file" id="bulk-file-upload" accept=".xlsx, .xls, .csv" class="w-full px-3 py-2 border border-slate-300 rounded-lg bg-white text-sm">
                            </div>
                            <button onclick="app.handleImportClick()" class="px-6 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 transition-colors">Import Group...</button>
                        </div>
                    </div>
                    <div id="presets-ui-container" class="mt-6">
                        <h3 class="text-lg font-semibold text-slate-800 mb-3">4. Set Group Priority</h3>
                        <p class="text-sm text-slate-600 mb-4">Drag and drop groups to set their merge priority. Groups at the bottom have higher priority and will override values from groups above them.</p>
                        <div id="preset-groups-container" class="bg-slate-50 p-4 rounded-lg border">
                            <!-- Preset groups will be rendered here -->
                        </div>
                    </div>
                </div>
                <div class="mt-8 flex justify-between">
                    <button onclick="app.showStep(1)" class="px-6 py-2 border border-slate-300 rounded-lg hover:bg-slate-50">‚Üê Back</button>
                    <button onclick="app.showStep(3)" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Generate Bookmarklet ‚Üí</button>
                </div>
            </div>
            
            <!-- Step 3: Generate Final Bookmarklet -->
            <div id="step3" class="step">
                <h2 class="text-2xl font-semibold text-slate-800 mb-6 border-b pb-4">
                    <span class="inline-block bg-purple-100 text-purple-800 text-sm font-semibold px-3 py-1 rounded-full mr-2">Phase 3</span>
                    Generate Bookmarklets
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                     <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                         <h3 class="text-lg font-semibold text-green-800 mb-2">Form Filler</h3>
                        <div class="mb-6">
                            <label for="final-bookmarklet-name" class="block text-sm font-semibold text-slate-700 mb-2">Bookmarklet Name</label>
                            <input type="text" id="final-bookmarklet-name" class="w-full px-3 py-2 border border-slate-300 rounded-lg" value="IM Form Filler">
                        </div>
                        <button onclick="app.generateFinalBookmarklet()" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 w-full">Generate Filler</button>
                        <div id="final-output" style="display: none;" class="mt-6 text-center">
                            <p class="text-slate-600 mb-4">Drag this to your bookmarks bar:</p>
                            <div id="final-bookmarklet-link-container"></div>
                        </div>
                    </div>
                    <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                        <h3 class="text-lg font-semibold text-red-800 mb-2">Form Clearer</h3>
                        <div class="mb-6">
                            <label for="clear-bookmarklet-name" class="block text-sm font-semibold text-slate-700 mb-2">Bookmarklet Name</label>
                            <input type="text" id="clear-bookmarklet-name" class="w-full px-3 py-2 border border-slate-300 rounded-lg" value="IM Clear Form">
                        </div>
                        <button onclick="app.generateClearBookmarklet()" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 w-full">Generate Clearer</button>
                        <div id="clear-output" style="display: none;" class="mt-6 text-center">
                            <p class="text-slate-600 mb-4">Drag this to your bookmarks bar:</p>
                            <div id="clear-bookmarklet-link-container"></div>
                        </div>
                    </div>
                </div>
                 <div class="mt-8 flex justify-between">
                    <button onclick="app.showStep(2)" class="px-6 py-2 border border-slate-300 rounded-lg hover:bg-slate-50">‚Üê Back</button>
                </div>
            </div>

            <!-- Step 4: Help -->
            <div id="step4" class="step">
                <h2 class="text-2xl font-semibold text-slate-800 mb-6 border-b pb-4">Help & Documentation</h2>
                <div class="prose max-w-none text-slate-700">
                    <h4>Overview</h4>
                    <p>This tool creates bookmarklets to automate filling complex forms by using hierarchical "Preset Groups".</p>
                    <h4>Phase 1: Generate Field Mapping Tool</h4>
                    <p>Create a "mapper" bookmarklet. Run it on the target form to visually map source fields (like a dropdown) to destination fields. This generates a JSON configuration that defines the form's structure.</p>
                    <h4>Phase 2: Configure Presets</h4>
                    <ol>
                        <li><strong>Load Mappings:</strong> Paste the JSON from the mapper tool into the text area and click "Load Mappings".</li>
                        <li><strong>Import Preset Groups:</strong> Import one or more Excel spreadsheets. Each spreadsheet will become a "Preset Group". You will be asked to name each group upon import (e.g., "Locations", "Roles", "Departments").</li>
                        <li><strong>Set Hierarchy:</strong> After importing, drag and drop the groups in the list to set their priority. Groups at the bottom of the list have higher priority and their data will override data from groups above them in case of a conflict.</li>
                    </ol>
                    <h4>Phase 3: Generate Bookmarklets</h4>
                    <p>This final step generates the "Filler" and "Clearer" bookmarklets. When you run the Filler on the target form, it will show a dropdown menu for each Preset Group you created.</p>
                </div>
                <div class="mt-8">
                    <button onclick="app.showStep(1)" class="px-6 py-2 border border-slate-300 rounded-lg hover:bg-slate-50">‚Üê Back to Start</button>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Unified Modal -->
    <div id="app-modal" class="modal-backdrop">
        <div class="modal-content">
            <h3 id="modal-title" class="text-lg font-semibold text-slate-800 mb-4"></h3>
            <p id="modal-text" class="text-slate-700 mb-4 whitespace-pre-wrap"></p>
            <div id="modal-fields"></div>
            <div id="modal-buttons" class="mt-6 text-right space-x-2"></div>
        </div>
    </div>

    <template id="preset-group-template">
        <div class="group-item" draggable="true">
            <div class="flex items-center">
                <svg class="w-5 h-5 text-slate-400 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                <strong data-name></strong>
            </div>
            <div>
                <button data-action="view" class="text-sm text-blue-600 hover:underline">View Presets</button>
                <button data-action="delete" class="text-sm text-red-600 hover:underline ml-4">&times; Delete</button>
            </div>
        </div>
    </template>

<script>
// App v5.0: Fixed critical syntax error in builder bookmarklet.
const app = {
    // STATE & CONSTANTS
    state: {
        mappings: null,
        mappingsByField: null,
        presets: { defaults: {}, groups: [] },
        pendingImportData: null
    },
    ui: {},
    modalResolve: null,
    draggedItem: null,
    CSS: {
        BTN_PRIMARY: 'bg-blue-600 text-white',
        BTN_DANGER: 'bg-red-600 text-white',
        INPUT: 'w-full px-3 py-2 border border-slate-300 rounded-lg text-sm',
    },
    DUALLIST_POLL_INTERVAL: 50,
    DUALLIST_MAX_TRIES: 100,

    // CORE APP LOGIC
    init() {
        this.ui = {
            steps: Array.from({length: 4}, (_, i) => document.getElementById(`step${i+1}`)),
            mappingsJson: document.getElementById('mappings-json'),
            presetsConfigSection: document.getElementById('presets-config-section'),
            presetGroupsContainer: document.getElementById('preset-groups-container'),
            modal: document.getElementById('app-modal'),
            modalTitle: document.getElementById('modal-title'),
            modalText: document.getElementById('modal-text'),
            modalFields: document.getElementById('modal-fields'),
            modalButtons: document.getElementById('modal-buttons'),
            fileInput: document.getElementById('bulk-file-upload'),
        };
        const builderScript = this.BUILDER_TOOL.getMinifiedScript();
        document.getElementById('builder-bookmarklet-link').href = 'javascript:' + encodeURIComponent(builderScript);
        this.showStep(1);
        this.addDragDropListeners();
    },

    showStep(stepNumber) {
        this.ui.steps.forEach((step, index) => step.classList.toggle('active', index + 1 === stepNumber));
    },

    renderPresetUI() {
        this.safely(async () => {
            const jsonInput = this.ui.mappingsJson.value;
            if (!jsonInput) return this.showError('Please paste the mappings JSON first.');
            this.state.mappings = JSON.parse(jsonInput);
            this.state.mappingsByField = Object.fromEntries(this.state.mappings.map(m => [this._fieldId(m), m]));
            this.ui.presetsConfigSection.style.display = 'block';
            this.rerenderGroupsUI();
        }, 'JSON Parse');
    },

    // MODAL & MESSAGE SYSTEM
    _modalButtonClick(value, hasInputs) {
        const results = hasInputs ? Array.from(this.ui.modalFields.querySelectorAll('select, input')).map(el => el.value) : value;
        this.hideModal(results);
    },

    showModal(config) {
        return new Promise(resolve => {
            if (this.modalResolve) { this.modalResolve(null); }
            this.modalResolve = resolve;
            this.ui.modalTitle.textContent = config.title || '';
            this.ui.modalText.textContent = config.message || '';
            this.ui.modalText.style.display = config.message ? 'block' : 'none';
            let fieldsHtml = '';
            if (config.inputs) config.inputs.forEach((inputConfig, index) => { fieldsHtml += this._generateModalFieldHtml(index, inputConfig); });
            this.ui.modalFields.innerHTML = fieldsHtml;
            this.ui.modalButtons.innerHTML = (config.buttons || [{ text: 'OK', value: true, class: this.CSS.BTN_PRIMARY }]).map(btn => 
                `<button class="px-6 py-2 rounded-lg ${btn.class || 'bg-slate-200 text-slate-800'}" onclick="app._modalButtonClick(${JSON.stringify(btn.value)}, ${!!config.inputs})">${btn.text}</button>`
            ).join('');
            this.ui.modal.classList.add('visible');
        });
    },

    hideModal(value = null) {
        this.ui.modal.classList.remove('visible');
        if (this.modalResolve) { this.modalResolve(value); this.modalResolve = null; }
    },
    
    msg: (msg, icon, title) => app.showModal({title: `${icon} ${title}`, message: msg}),
    showError: (msg, title = 'Error') => app.msg(msg, '‚ùå', title),
    showSuccess: (msg) => app.msg(msg, '‚úÖ', 'Success'),
    async confirmAction(message, confirmText = 'Confirm') {
        return await this.showModal({ title: '‚ùì Confirm', message, buttons: [{text: 'Cancel', value: false}, {text: confirmText, value: true, class: this.CSS.BTN_PRIMARY}] });
    },

    async safely(fn, errorContext = 'Operation') {
        try { return await fn(); } 
        catch (e) { await this.showError(`${errorContext}: ${e.message}`); return null; }
    },

    // UTILITY HELPERS
    _fieldId: m => m.destinations[0].id,
    escapeHtml: str => String(str || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]),

    // EXCEL & IMPORT
    downloadXlsxTemplate() {
        if (!this.state.mappings) return this.showError('Load mappings first.');
        const headers = ['Name', ...this.state.mappings.map(this._fieldId)];
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet([headers]);
        XLSX.utils.book_append_sheet(wb, ws, 'Presets');
        XLSX.writeFile(wb, 'Preset_Template.xlsx');
    },

    handleImportClick() {
        this.safely(async () => {
            if (!this.ui.fileInput.files?.length) return this.showError('Please select a file to import.');
            const reader = new FileReader();
            reader.onload = async (e) => {
                await this.safely(async () => {
                    const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    if (!sheet) throw new Error("Spreadsheet contains no sheets.");
                    const data = XLSX.utils.sheet_to_json(sheet);
                    if (data.length === 0) throw new Error('Spreadsheet has no data rows.');
                    if (!data[0].Name && !data[0].name) throw new Error('Spreadsheet is missing "Name" column.');
                    
                    const results = await this.showModal({
                        title: '‚ùì Name Your Preset Group',
                        message: `Importing ${data.length} presets. Give this group a name.`,
                        inputs: [ { label: 'Group Name', placeholder: 'e.g., Locations' } ],
                        buttons: [{ text: 'Cancel', value: null }, { text: 'Import', value: 'import', class: 'bg-amber-600 text-white' }]
                    });

                    if (results) {
                        const groupName = results[0];
                        if (!groupName) return this.showError('Group name cannot be empty.');
                        if (this.state.presets.groups.some(g => g.name === groupName)) return this.showError(`A group named "${groupName}" already exists.`);
                        this.processImport(groupName, data);
                    }
                }, 'File Read');
            };
            reader.readAsArrayBuffer(this.ui.fileInput.files[0]);
        });
    },

    processImport(groupName, importData) {
        const groupData = {};
        importData.forEach(row => {
            const presetName = row.Name || row.name;
            if (!presetName) return;
            const preset = {};
            for (const fieldId in row) {
                if (fieldId.toLowerCase() === 'name') continue;
                const mapping = this.state.mappingsByField[fieldId];
                if (mapping) {
                    preset[fieldId] = (mapping.format === 'code:description' && row[fieldId]) 
                        ? String(row[fieldId]).split(':')[0].trim() 
                        : row[fieldId];
                }
            }
            groupData[presetName] = preset;
        });
        
        this.state.presets.groups.push({ name: groupName, data: groupData });
        this.rerenderGroupsUI();
        this.ui.fileInput.value = '';
        this.showSuccess(`Group "${groupName}" imported successfully.`);
    },

    // PRESET GROUP UI & MANAGEMENT
    rerenderGroupsUI() {
        this.ui.presetGroupsContainer.innerHTML = '';
        if (this.state.presets.groups.length === 0) {
            this.ui.presetGroupsContainer.innerHTML = '<p class="text-slate-500 text-center py-4">No preset groups imported yet.</p>';
            return;
        }
        this.state.presets.groups.forEach((group, index) => {
            const template = document.getElementById('preset-group-template').content.cloneNode(true);
            const groupEl = template.querySelector('.group-item');
            groupEl.dataset.index = index;
            groupEl.querySelector('[data-name]').textContent = group.name;
            groupEl.querySelector('[data-action="view"]').onclick = () => this.viewGroupPresets(index);
            groupEl.querySelector('[data-action="delete"]').onclick = () => this.deleteGroup(index);
            this.ui.presetGroupsContainer.appendChild(groupEl);
        });
    },

    async viewGroupPresets(index) {
        const group = this.state.presets.groups[index];
        if (!group) return;
        let content = `<div class="max-h-96 overflow-y-auto -mx-4 px-4">`;
        Object.entries(group.data).forEach(([presetName, values]) => {
            content += `<div class="preset-card !p-3 !mt-2"><strong class="text-slate-800">${presetName}</strong><div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-1 mt-2 text-sm">`;
            Object.entries(values).forEach(([field, value]) => {
                content += `<div><span class="font-medium text-slate-600">${field}:</span> ${this.escapeHtml(value)}</div>`;
            });
            content += `</div></div>`;
        });
        content += `</div>`;
        await this.showModal({ title: `Presets in "${group.name}"`, message: content });
    },

    async deleteGroup(index) {
        const groupName = this.state.presets.groups[index]?.name;
        if (!groupName) return;
        if (await this.confirmAction(`Are you sure you want to delete the "${groupName}" group?`, 'Delete')) {
            this.state.presets.groups.splice(index, 1);
            this.rerenderGroupsUI();
        }
    },
    
    addDragDropListeners() {
        const container = this.ui.presetGroupsContainer;
        container.addEventListener('dragstart', e => { this.draggedItem = e.target; setTimeout(() => e.target.classList.add('dragging'), 0); });
        container.addEventListener('dragend', e => { this.draggedItem.classList.remove('dragging'); this.draggedItem = null; });
        container.addEventListener('dragover', e => {
            e.preventDefault();
            const afterElement = this.getDragAfterElement(container, e.clientY);
            const current = document.querySelector('.dragging');
            if (afterElement == null) container.appendChild(current);
            else container.insertBefore(current, afterElement);
        });
        container.addEventListener('drop', e => {
            const newOrder = Array.from(container.querySelectorAll('.group-item')).map(el => this.state.presets.groups[parseInt(el.dataset.index, 10)]);
            this.state.presets.groups = newOrder;
            this.rerenderGroupsUI();
        });
    },

    getDragAfterElement(container, y) {
        const draggable = [...container.querySelectorAll('.group-item:not(.dragging)')];
        return draggable.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            return (offset < 0 && offset > closest.offset) ? { offset, element: child } : closest;
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    },
    
    // BOOKMARKLET GENERATION
    async _generateBookmarklet(config) {
        const name = document.getElementById(config.nameInputId).value.trim();
        if (!name) return this.showError('Please provide a name.');
        const logic = config.logic.replace(/\s+/g, ' ').trim();
        const script = 'javascript:(function(){' + encodeURIComponent(logic) + '})()';
        await this.showModal({ title: '‚úÖ Generated!', message: `Drag this link to your bookmarks bar.`, buttons: [{text: 'Close', value: true}]});
        document.getElementById(config.linkContainerId).innerHTML = `<a href="${script.replace(/"/g, '&quot;')}" class="inline-block px-8 py-3 ${config.buttonClass} text-white font-semibold rounded-lg shadow-md">${this.escapeHtml(name)}</a>`;
        document.getElementById(config.outputContainerId).style.display = 'block';
    },

    async generateFinalBookmarklet() {
        if (!this.state.mappings) return await this.showError('Load mappings first.');
        const fieldMeta = {}, lookup = {};
        this.state.mappings.forEach(m => {
            const destId = this._fieldId(m);
            fieldMeta[destId] = { t: m.destinations[0].type, f: m.format || 'text', a: m.destinations[0].addAll, s: m.sourceId };
            if (m.format === 'code:description' && m.sourceOptions?.length > 0) {
                lookup[destId] = {};
                m.sourceOptions.forEach(opt => { const [code] = opt.split(':'); if (code?.trim()) lookup[destId][code.trim()] = opt; });
            }
        });
        const logic = this.BOOKMARKLET_UTILITIES + this.FILLER_LOGIC
            .replace('__LOOKUP_DATA__', JSON.stringify(lookup))
            .replace('__FIELDMETA_DATA__', JSON.stringify(fieldMeta))
            .replace('__PRESETS_DATA__', JSON.stringify(this.state.presets));
        await this._generateBookmarklet({ nameInputId: 'final-bookmarklet-name', logic, linkContainerId: 'final-bookmarklet-link-container', outputContainerId: 'final-output', buttonClass: this.CSS.BTN_SUCCESS });
    },

    async generateClearBookmarklet() {
        if (!this.state.mappings) return await this.showError('Load mappings first.');
        const fields = this.state.mappings.map(this._fieldId);
        const logic = this.BOOKMARKLET_UTILITIES + this.CLEAR_LOGIC.replace('__FIELDS_DATA__', JSON.stringify(fields));
        await this._generateBookmarklet({ nameInputId: 'clear-bookmarklet-name', logic, linkContainerId: 'clear-bookmarklet-link-container', outputContainerId: 'clear-output', buttonClass: this.CSS.BTN_DANGER });
    },
    
    BOOKMARKLET_UTILITIES: `function getEl(i){return document.getElementById(i)||document.getElementsByName(i)[0]}function trigger(e,v){e.dispatchEvent(new Event(v,{bubbles:true}))}`,
    FILLER_LOGIC: `const L=__LOOKUP_DATA__,M=__FIELDMETA_DATA__,P=__PRESETS_DATA__;function resolve(i,v){const m=M[i];if(!m||m.f!=='code:description'||!L[i])return v;return L[i][v]||v}function fill(i,v){try{const e=getEl(i);if(!e)return;const m=M[i];if(m.t==='duallist'){const sId=m.s||(i+'.Options'),sEl=getEl(sId);if(!sEl)return;const c=e.closest('td,div'),p=c?.parentElement;if(!p)return;const a=p.querySelector('input[name="action.'+i+'.OptionSelectorAdd"]'),r=p.querySelector('input[name="action.'+i+'.OptionSelectorRemove"]'),dL=e;if(!a||!r)return;const add=()=>{let vs=m.a?Object.values(L[i]||{}):String(v).split(',').map(v=>resolve(i,v.trim()));Array.from(sEl.options).forEach(o=>{o.selected=vs.some(v=>(o.text.trim()===v||o.text.trim().startsWith(v+':')))});a.click()};if(dL.options.length>0){Array.from(dL.options).forEach(o=>o.selected=true);r.click();let t=0;const p=setInterval(()=>{if(dL.options.length===0||++t>100){clearInterval(p);if(dL.options.length===0)add()}},50)}else add()}else if(m.t==='select'){const rV=resolve(i,v),opt=Array.from(e.options).find(o=>o.text.trim()===rV||o.text.trim().startsWith(rV));if(opt)e.value=opt.value;else e.value=rV;trigger(e,'change')}else{e.value=resolve(i,v);trigger(e,'input');trigger(e,'change')}}catch(e){console.error('Error filling',i,':',e)}}function showUI(){const id='_formFillerUI';if(document.getElementById(id))return;let selects='';P.groups.forEach((g,i)=>{selects+='<div style="margin-bottom:12px;"><label>'+g.name+':</label><select id="_group_'+i+'" style="width:100%"><option value="">--</option>'+Object.keys(g.data).map(n=>'<option value="'+n+'">'+n+'</option>').join('')+'</select></div>'});document.body.insertAdjacentHTML('beforeend','<div id="'+id+'" style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:99999;background:white;padding:24px;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,0.3);font-family:sans-serif;min-width:320px;"><h3 style="margin:0 0 16px;">Form Filler</h3>'+selects+'<button id="_fill" style="padding:8px 16px;background:#3b82f6;color:white;border:none;border-radius:6px;cursor:pointer;margin-right:8px;">Fill</button><button onclick="this.parentElement.remove()" style="padding:8px 16px;background:#6b7280;color:white;border:none;border-radius:6px;cursor:pointer;">Cancel</button></div>');document.getElementById('_fill').onclick=()=>{let merged={...P.defaults};P.groups.forEach((g,i)=>{const sel=document.getElementById('_group_'+i).value;if(sel&&g.data[sel]){merged={...merged,...g.data[sel]}}});for(const f in merged)fill(f,merged[f]);document.getElementById(id).remove()}}try{showUI()}catch(e){alert('Error: '+e.message)}}`,
    CLEAR_LOGIC: `const F=__FIELDS_DATA__;F.forEach(i=>{const e=getEl(i);if(!e)return;if(e.tagName==='SELECT'&&e.multiple){const r=e.closest('td,div')?.parentElement?.querySelector('input[name="action.'+i+'.OptionSelectorRemove"]');if(r&&e.options.length>0){Array.from(e.options).forEach(o=>o.selected=true);r.click();return}}e.value='';trigger(e,'input');trigger(e,'change')});alert('Mapped fields cleared.')`,
    
    BUILDER_TOOL: {
        getMinifiedScript() { return this.BUILDER_LOGIC.replace(/\s+/g, ' ').trim(); },
        BUILDER_LOGIC: `
            (function(){
                if(document.getElementById('mUI'))return;
                const S={m:[],cS:null,cD:null,mode:null,lH:null};
                function gId(e){return e.id||e.name}
                function aF(o){if(!o?.length)return'text';const c=o.filter(p=>!/Enter one|Select one|Almost every/.test(p));if(c.length===0)return'text';if(c.filter(p=>/^\\d+:/.test(p.trim())).length/c.length>0.7)return'code:description';if(c.every(p=>/^[A-Z]+$/.test(p)&&p.length<20))return'enum';if(c.every(p=>/^\\d+$/.test(p.trim())))return'plain';return'text'}
                function scrS(e){const i=gId(e);if(!i)return alert('No ID/name');const s={sId:i,sO:[],fmt:'unknown',addAll:false};if(e.tagName==='SELECT'){s.sO=Array.from(e.options).map(o=>o.text.trim()).filter(Boolean);s.fmt=aF(s.sO)}S.cS=s;upd()}
                function scrD(e){const i=gId(e);if(!i)return alert('No ID/name');if(i.endsWith('.Options'))return alert('Cannot use .Options as destination.');if(e.tagName==='SELECT'&&e.hasAttribute('readonly')&&document.querySelector('[name="'+i+'1"]'))alert('Map to editable version: '+i+'1');const d={id:i,type:'text',addAll:false};if(e.tagName==='SELECT')d.type=document.querySelector('[name="'+i+'.Options"]')?'duallist':'select';S.cD=d;upd()}
                function cMap(){if(!S.cS||!S.cD)return alert('Select source & destination.');const d=S.m.find(m=>m.sId===S.cS.sId&&m.destinations[0].id===S.cD.id);if(d&&!window.confirm('Mapping exists. Add again?'))return;if(S.cD.type==='duallist'){S.cD.addAll=document.getElementById('_aACb').checked;const ex=S.cD.id+'.Options';if(S.cS.sId!==ex&&!window.confirm('Warning: For "'+S.cD.id+'", source should be "'+ex+'". You chose "'+S.cS.sId+'". Continue?'))return}S.m.push({...S.cS,destinations:[S.cD]});S.cS=null;S.cD=null;S.mode=null;document.body.style.cursor='default';upd()}
                function setM(m){S.mode=m;document.body.style.cursor='crosshair';upd()}
                function hMO(e){const t=e.target.closest('select,input,textarea');if(!S.mode||!t)return;S.lH=t;t.style.outline='2px solid red'}
                function hMOu(e){if(S.lH)S.lH.style.outline=''}
                function hC(e){if(!S.mode)return;const t=e.target.closest('select,input,textarea');if(!t)return;e.preventDefault();e.stopPropagation();if(S.lH)S.lH.style.outline='';if(S.mode==='source')scrS(t);else scrD(t);S.mode=null;document.body.style.cursor='default'}
                function upd(){const r=document.getElementById('mUI');if(!r)return;const mH=S.m.map((m,i)=>'<div style="padding:4px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;"><span><b>'+m.sId+'</b> &rarr; <b>'+m.destinations[0].id+'</b>'+(m.destinations[0].addAll?' (All)':'')+'</span><button onclick="window._m.rM('+i+')" style="border:none;background:transparent;color:#ef4444;cursor:pointer;">&times;</button></div>').join('')||'<p style="color:#999;text-align:center;padding:10px 0;">No mappings.</p>';const sT=S.cS?S.cS.sId+' ('+S.cS.fmt+')':'None',dT=S.cD?S.cD.id+' ('+S.cD.type+')':'None';const aAD=S.cD?.type==='duallist'?'block':'none';r.innerHTML='<div style="background:#2d3748;color:white;padding:12px;font-weight:bold;">Mapper v5.2</div><div style="padding:16px;"><div style="padding:8px;background:#fffacd;border:1px solid #f0e68c;margin-bottom:12px;font-size:11px;border-radius:4px;"><b>Tip:</b> Map ".Options" as SOURCE, regular field as DESTINATION.</div><div style="display:flex;gap:10px;margin-bottom:10px;"><button onclick="window._m.setM(\\'source\\')" class="m-btn '+(S.mode==='source'?'act':'')+'">1. Select Source</button><button onclick="window._m.setM(\\'destination\\')" class="m-btn '+(S.mode==='destination'?'act':'')+'">2. Select Dest</button></div><div style="font-size:12px;padding:8px;background:#edf2f7;border-radius:4px;"><b>Src:</b> '+sT+'<br><b>Dest:</b> '+dT+'</div><div style="margin-top:8px;font-size:12px;display:'+aAD+';"><label><input type="checkbox" id="_aACb"> Add All Source Options</label></div><button onclick="window._m.cMap()" class="m-btn" style="background:#38a169;color:white;width:100%;margin-top:10px;">3. Commit</button><div style="margin-top:12px;border-top:1px solid #e2e8f0;padding-top:8px;"><b>Mappings</b><div style="max-height:120px;overflow-y:auto;border:1px solid #ccc;background:white;margin-top:4px;">'+mH+'</div></div></div><div style="padding:12px;background:#edf2f7;border-top:1px solid #e2e8f0;"><button onclick="window._m.gJ()" class="m-btn" style="background:#dd6b20;color:white;width:100%;font-weight:bold;">Generate & Copy JSON</button><button onclick="window._m.destroy()" style="background:none;border:none;color:#718096;font-size:12px;cursor:pointer;margin-top:4px;width:100%;">Close</button></div><style>.m-btn{padding:8px;border:1px solid #ccc;background:white;border-radius:4px;cursor:pointer;flex-grow:1;}.m-btn.act{background:#3182ce;color:white;}</style>'}
                function gJ(){const j=JSON.stringify(S.m,null,2);const t=document.createElement('textarea');t.value=j;document.body.appendChild(t);t.select();try{document.execCommand('copy');alert('JSON copied!')}catch(e){alert('Copy failed');console.log(j)}document.body.removeChild(t)}
                function rM(i){S.m.splice(i,1);upd()}function destroy(){if(S.lH)S.lH.style.outline='';document.removeEventListener('mouseover',hMO);document.removeEventListener('mouseout',hMOu);document.removeEventListener('click',hC,true);document.getElementById('mUI').remove()}
                const r=document.createElement('div');r.id='mUI';r.style.cssText='position:fixed;top:20px;right:20px;z-index:10001;width:350px;background:#f7fafc;border:1px solid #ccc;border-radius:8px;box-shadow:0 5px 15px rgba(0,0,0,0.2);font-family:sans-serif;font-size:14px;';document.body.appendChild(r);upd();document.addEventListener('mouseover',hMO);document.addEventListener('mouseout',hMOu);document.addEventListener('click',hC,true);window._m={setM,cMap,gJ,rM,destroy};
            })()`
    }
};

document.addEventListener('DOMContentLoaded', () => { window.app = app; app.init(); });
</script>
</body>
</html>

