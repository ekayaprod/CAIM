<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CA Identity Manager Preset Generator</title>
    <style>
        :root {
            --bg-light: #f1f5f9; --bg-white: #ffffff; --border-color: #cbd5e1;
            --text-dark: #1e2b3b; --text-med: #475569; --text-light: #64748b;
            --accent-blue: #2563eb; --accent-blue-hover: #1d4ed8; --accent-light: #eff6ff;
            --green: #16a34a; --green-light: #f0fdf4;
        }
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--bg-light); color: var(--text-med); line-height: 1.5;
        }
        .container { width: 100%; max-width: 64rem; margin: 2rem auto; }
        .app-main {
            background-color: var(--bg-white); padding: 2rem; border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        header { text-align: center; margin-bottom: 2rem; }
        .step { display: none; }
        .step.active { display: block; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        textarea, input[type="text"] {
            width: 100%; margin-top: 0.25rem; padding: 0.5rem 0.75rem;
            background-color: var(--bg-white); border: 1px solid var(--border-color); border-radius: 0.375rem;
            box-sizing: border-box; font: inherit;
        }
        textarea { font-family: monospace; font-size: 0.8rem; height: 200px; }
        .btn {
            padding: 0.5rem 1rem; border-radius: 0.375rem; border: 1px solid transparent;
            font-weight: 500; cursor: pointer; transition: background-color 0.2s;
        }
        .btn-primary { background-color: var(--accent-blue); color: var(--bg-white); }
        .btn-primary:hover { background-color: var(--accent-blue-hover); }
        .btn-secondary { border-color: var(--border-color); }
        .card { padding: 1.5rem; background-color: var(--bg-light); border-radius: 0.75rem; margin-top: 1rem; }
        h1 { font-size: 2.25rem; font-weight: 700; color: var(--text-dark); margin: 0; }
        h2 { font-size: 1.5rem; font-weight: 600; color: var(--text-dark); margin-top: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 0.75rem; margin-bottom: 1rem; }
        .pill { background-color: var(--accent-light); color: var(--accent-blue); padding: 0.25rem 0.75rem; border-radius: 99px; font-size: 0.8rem; font-weight: 500; }
        .preset-card { background: white; border: 1px solid var(--border-color); border-radius: .5rem; padding: 1rem; margin-top: .5rem; }
        .preset-field { margin-top: .5rem; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>CA Identity Manager Preset Generator</h1>
            <p>The complete environment for building and deploying your form filler.</p>
        </header>

        <main class="app-main">

            <div class="step active" id="step1">
                <h2><span class="pill">Phase 1</span> Generate the Builder Bookmarklet</h2>
                <div class="card">
                    <p style="margin-top:0;">This first bookmarklet is the **Builder Tool**. Its job is to analyze your form. Drag it to your bookmarks bar, open your Identity Manager form, and click it. A panel will appear to guide you through mapping the form's fields.</p>
                    <div style="text-align: center; margin: 1.5rem 0;">
                        <a href="" id="builder-bookmarklet-link" class="btn btn-primary">Drag Builder Tool to Bookmarks</a>
                    </div>
                </div>
                <div style="display: flex; justify-content: flex-end; align-items: center; margin-top: 2rem;">
                    <button onclick="app.showStep(2)" class="btn btn-primary">Proceed to Phase 2 &rarr;</button>
                </div>
            </div>

            <div class="step" id="step2">
                 <h2><span class="pill">Phase 2</span> Configure Presets</h2>
                 <p>After using the Builder Tool, paste the `field_mappings.json` it generated into the box below. Then, create your Location and Role presets.</p>
                 <div>
                    <label><strong>Field Mappings JSON</strong> (from Builder Tool)</label>
                    <textarea id="mappings-json"></textarea>
                 </div>
                 <button onclick="app.renderPresetUI()" class="btn btn-secondary" style="margin-top:1rem;">Load Mappings & Build Preset UI</button>
                 
                 <div id="presets-ui-container" style="margin-top: 1.5rem;">
                    <div id="defaults-container" class="card" style="background-color: var(--bg-white);">
                        <h3>Default Values</h3>
                        <div id="defaults-presets"></div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-top: 1.5rem;">
                        <div><h3>Locations</h3><div id="locations-presets"></div><button onclick="app.addPreset('locations')" class="btn btn-secondary" style="margin-top:1rem;">+ Add Location</button></div>
                        <div><h3>Roles</h3><div id="roles-presets"></div><button onclick="app.addPreset('roles')" class="btn btn-secondary" style="margin-top:1rem;">+ Add Role</button></div>
                    </div>
                 </div>
                 <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 2rem;">
                    <button onclick="app.showStep(1)" class="btn btn-secondary">&larr; Back to Phase 1</button>
                    <button onclick="app.showStep(3)" class="btn btn-primary">Proceed to Phase 3 &rarr;</button>
                </div>
            </div>

            <div class="step" id="step3">
                <h2><span class="pill">Phase 3</span> Generate the Final Bookmarklet</h2>
                <div class="card" style="background-color: var(--green-light); text-align:center;">
                    <p style="margin-top:0; color: var(--green)">You're ready to generate the final tool for your end-users. This bookmarklet contains all the mapping and preset logic you just configured.</p>
                    <input type="text" id="final-bookmarklet-name" placeholder="Enter a name for the final bookmarklet..." style="margin: 1rem 0; text-align:center;">
                    <br>
                    <button onclick="app.generateFinalBookmarklet()" class="btn btn-primary" style="background-color:var(--green);">Generate Final Bookmarklet</button>
                    <div id="final-output" style="margin-top: 1.5rem; display:none;">
                        <p><strong>Success!</strong> Drag the green link below to your bookmarks bar.</p>
                        <div id="final-bookmarklet-link-container"></div>
                    </div>
                </div>
                 <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 2rem;">
                    <button onclick="app.showStep(2)" class="btn btn-secondary">&larr; Back to Phase 2</button>
                    <button onclick="app.showStep(1)" class="btn btn-primary">Start Over</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Template for Preset Cards -->
    <template id="preset-card-template">
        <div class="preset-card">
            <strong data-name></strong>
            <div data-fields-container></div>
        </div>
    </template>

<script>
const BUILDER_TOOL = {
    generateScript: () => {
        // Using standard string concatenation to build the script for maximum compatibility.
        const builderLogic = 'const state={panelId:"idm-builder-"+Date.now(),mode:null,currentSource:null,currentDestinations:[],mappings:[]};function cleanup(){const e=document.getElementById(state.panelId);e&&e.remove(),document.body.style.cursor="default",document.removeEventListener("click",clickHandler,!0)}function setMode(e){state.mode=e,document.body.style.cursor="crosshair",document.getElementById(state.panelId+"-mode-display").textContent="Current Mode: "+e}function scrapeSource(e){const t={sourceId:e.id||e.name,sourceOptions:[],sourceValue:null};"SELECT"===e.tagName?t.sourceOptions=Array.from(e.options).map(e=>e.text.trim()).filter(Boolean):t.sourceValue=e.value||"",state.currentSource=t,updateUI()}function scrapeDestination(e){const t={id:e.id||e.name,type:"text",allowMultiple:!!e.multiple,defaultValue:e.value||""};if("SELECT"===e.tagName){const o=e.closest("td, div"),n=o?o.parentElement:e.parentElement;n&&n.querySelector(\'input[id*="OptionSelectorAdd"], button[id*="add"]\')?t.type="duallist":t.type="select"}state.currentDestinations.find(o=>o.id===t.id)||state.currentDestinations.push(t),updateUI()}function commitMapping(){if(!state.currentSource||0===state.currentDestinations.length)return void alert("Please select a source and at least one destination.");const e={...state.currentSource,destinations:state.currentDestinations};state.mappings.push(e),state.currentSource=null,state.currentDestinations=[],state.mode=null,document.body.style.cursor="default",updateUI()}function generateJSON(){const e=JSON.stringify(state.mappings,null,2),t=document.getElementById(state.panelId+"-json-output");t.value=e,t.style.display="block",t.select(),alert("JSON generated. Copy it from the text area.")}function updateUI(){const e=document.getElementById(state.panelId+"-current-source"),t=document.getElementById(state.panelId+"-current-dests"),o=document.getElementById(state.panelId+"-mappings-list");e.innerHTML=state.currentSource?"<strong>Source:</strong> "+state.currentSource.sourceId:"<em>No source selected</em>",t.innerHTML=state.currentDestinations.length>0?"<strong>Destinations:</strong> "+state.currentDestinations.map(function(e){return e.id+" ("+(e.allowMultiple?"multi":"single")+")"}).join(", "):"<em>No destinations selected</em>",o.innerHTML=state.mappings.map(function(e,t){var o=e.destinations?e.destinations.map(function(e){return e.id}).join(", "):"";return\'<div style="border-top: 1px solid #eee; padding: 5px 0;"><strong>Mapping '+(t+1)+":</strong> "+e.sourceId+" &rarr; ["+o+"]</div>"}).join(""),document.getElementById(state.panelId+"-mode-display").textContent="Current Mode: "+(state.mode||"none")}function clickHandler(e){if(e.target.closest("#"+state.panelId))return;e.preventDefault(),e.stopPropagation();const t=e.target.closest("input:not([type=hidden]), select, textarea, button");t&&state.mode&&("source"===state.mode?scrapeSource(t):"destination"===state.mode&&scrapeDestination(t),state.mode=null,document.body.style.cursor="default",updateUI())}function buildUI(){if(document.getElementById(state.panelId))return;const e=\'<div id="\'+state.panelId+\'" style="position:fixed; top:10px; right:10px; width:400px; background:white; border:1px solid #ccc; border-radius:8px; box-shadow:0 4px 20px rgba(0,0,0,.2); z-index:999999; font-family:sans-serif; color: #333;"><h3 style="margin:0; padding:15px; background:#333; color:white; border-radius:8px 8px 0 0; font-size:16px;">Identity Manager Form Builder</h3><div style="padding:15px; display:flex; flex-direction:column; gap:10px;"><div style="display:flex; gap:10px;"><button id="\'+state.panelId+\'-source-btn" style="flex:1;">1. Map Source</button><button id="\'+state.panelId+\'-dest-btn" style="flex:1;">2. Map Destination(s)</button></div><div id="\'+state.panelId+\'-mode-display" style="text-align:center; font-style:italic; font-size:12px;">Current Mode: none</div><div style="border: 1px solid #eee; padding: 10px; border-radius: 4px;"><div id="\'+state.panelId+\'-current-source"><em>No source selected</em></div><div id="\'+state.panelId+\'-current-dests"><em>No destinations selected</em></div></div><button id="\'+state.panelId+\'-commit-btn" style="background-color: #28a745; color: white;">3. Commit Mapping</button><hr style="border:none; border-top:1px solid #eee;"><h4>Committed Mappings:</h4><div id="\'+state.panelId+\'-mappings-list" style="max-height:150px; overflow-y:auto; background:#f9f9f9; padding:5px;"></div><button id="\'+state.panelId+\'-generate-btn" style="background-color: #007bff; color: white;">4. Generate Mappings JSON</button><textarea id="\'+state.panelId+\'-json-output" style="display:none; height:100px;"></textarea><button id="\'+state.panelId+\'-close-btn">Close</button></div></div>\';document.body.insertAdjacentHTML("beforeend",e),document.getElementById(state.panelId+"-source-btn").onclick=function(){setMode("source")},document.getElementById(state.panelId+"-dest-btn").onclick=function(){setMode("destination")},document.getElementById(state.panelId+"-commit-btn").onclick=commitMapping,document.getElementById(state.panelId+"-generate-btn").onclick=generateJSON,document.getElementById(state.panelId+"-close-btn").onclick=cleanup,document.addEventListener("click",clickHandler,!0)}buildUI();';
        return 'javascript:(function(){' + encodeURIComponent(builderLogic) + '})()';
    }
};

const app = {
    state: {
        mappings: null,
        presets: { defaults: {}, locations: {}, roles: {} }
    },

    init() {
        const exampleMappings = [ { sourceId: 'IpamCounties.Options', sourceOptions: ['00:No County', '01:Adams', '02:Allegheny'], destinations: [{ id: 'IpamCounties', type: 'duallist', allowMultiple: true, defaultValue: '' }] }, { sourceId: 'some_source_field', sourceOptions: [], sourceValue: 'Default Text', destinations: [{ id: 'a_text_field', type: 'text', allowMultiple: false, defaultValue: 'Initial value from form' }] } ];
        document.getElementById('mappings-json').value = JSON.stringify(exampleMappings, null, 2);
        document.getElementById('builder-bookmarklet-link').href = BUILDER_TOOL.generateScript();
    },

    showStep(stepNum) {
        document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
        document.getElementById('step' + stepNum).classList.add('active');
    },

    renderPresetUI() {
        try {
            this.state.mappings = JSON.parse(document.getElementById('mappings-json').value);
            if (!this.state.mappings || !Array.isArray(this.state.mappings)) throw new Error("Mappings data is not a valid array.");
            
            this.state.presets = { defaults: {}, locations: {}, roles: {} };
            document.getElementById('locations-presets').innerHTML = '';
            document.getElementById('roles-presets').innerHTML = '';
            
            const defaultsContainer = document.getElementById('defaults-presets');
            defaultsContainer.innerHTML = '';
            let hasDefaults = false;

            this.state.mappings.forEach(mapping => {
                if (!mapping.destinations || !Array.isArray(mapping.destinations)) return;
                mapping.destinations.forEach(dest => {
                    if (dest.type === 'text' && dest.defaultValue) {
                        hasDefaults = true;
                        this.state.presets.defaults[dest.id] = dest.defaultValue;
                        const fieldHTML = '<div class="preset-field"><label style="font-size: .8rem; font-weight: 500;">' + dest.id + '</label><input type="text" value="' + dest.defaultValue + '" onchange="app.updateDefaultValue(\'' + dest.id + '\', this.value)"></div>';
                        defaultsContainer.innerHTML += fieldHTML;
                    }
                });
            });
            document.getElementById('defaults-container').style.display = hasDefaults ? 'block' : 'none';

        } catch (e) {
            alert('Invalid JSON in Field Mappings: ' + e.message);
        }
    },

    updateDefaultValue(destId, value) {
        this.state.presets.defaults[destId] = value;
    },
    
    addPreset(type) {
        if (!this.state.mappings) { alert('Please load field mappings first.'); return; }
        const name = prompt('Enter name for new ' + type.slice(0, -1) + ':');
        if (!name || (this.state.presets[type] && this.state.presets[type][name])) {
            if (name) alert('A preset with this name already exists.');
            return;
        }
        
        if (!this.state.presets[type]) this.state.presets[type] = {};
        this.state.presets[type][name] = {};
        
        const template = document.getElementById('preset-card-template');
        const card = template.content.cloneNode(true);
        const cardElement = card.querySelector('.preset-card');
        const fieldsContainer = card.querySelector('[data-fields-container]');

        card.querySelector('[data-name]').textContent = name;
        cardElement.id = 'preset-' + type + '-' + name.replace(/\s+/g, '-');

        this.state.mappings.forEach(mapping => {
            if (!mapping.destinations || !Array.isArray(mapping.destinations)) return;
            mapping.destinations.forEach(dest => {
                const fieldWrapper = document.createElement('div');
                fieldWrapper.className = 'preset-field';
                
                const label = document.createElement('label');
                label.style.cssText = 'font-size: .8rem; font-weight: 500;';
                label.textContent = '' + dest.id + ' (' + (dest.allowMultiple ? 'multi' : 'single') + ')';

                const isMultiple = dest.allowMultiple;
                const select = document.createElement('select');
                select.style.cssText = 'width:100%; padding:.25rem; border:1px solid #ccc; border-radius:4px;';
                select.multiple = isMultiple;
                select.style.height = isMultiple ? '80px' : 'auto';
                
                select.onchange = () => {
                    const value = isMultiple ? Array.from(select.selectedOptions).map(o => o.value) : select.value;
                    this.updatePresetValue(type, name, dest.id, value);
                };

                if (!isMultiple) {
                    select.add(new Option('-- Choose Value --', ''));
                }
                mapping.sourceOptions.forEach(opt => select.add(new Option(opt, opt)));
                
                fieldWrapper.appendChild(label);
                fieldWrapper.appendChild(select);
                fieldsContainer.appendChild(fieldWrapper);
            });
        });
        
        document.getElementById(type + '-presets').appendChild(card);
    },

    updatePresetValue(type, presetName, destId, value) {
        if (!this.state.presets[type][presetName]) this.state.presets[type][presetName] = {};
        this.state.presets[type][presetName][destId] = value;
    },

    generateFinalBookmarklet() {
       const name = document.getElementById('final-bookmarklet-name').value.trim();
       if (!name) { alert('Please provide a name for the final bookmarklet.'); return; }
       
       const finalLogic = 'const MAPPINGS = ' + JSON.stringify(this.state.mappings) + '; const PRESETS = ' + JSON.stringify(this.state.presets) + '; function getElement(e){return document.getElementById(e)||document.getElementsByName(e)[0]}function applyPresets(e){MAPPINGS.forEach(function(t){t.destinations&&Array.isArray(t.destinations)&&t.destinations.forEach(function(o){const n=e[o.id];if("undefined"!=typeof n&&""!==n){const e=getElement(o.id);if(e){if("duallist"===o.type){const t=getElement(mapping.sourceId),n=e.closest("tr, div.row, div.form-group");if(!n)return void console.error("Could not find common container for",o.id);const d=n.querySelector(\'input[id*="OptionSelectorAdd"]:not([id*="AddAll"]), button[id*="add"]\');if(!t||!d)return void console.error("Could not find source list or add button for",o.id);const i=Array.isArray(value)?value:[value];Array.from(t.options).forEach(e=>{e.selected=i.includes(e.text.trim())}),d.click()}else e.value=n;e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0}))}}})})}function startApp(){const e="_idm_final_filler";if(document.getElementById(e))return;const t=Object.keys(PRESETS.locations).map(e=>\'<option value="\'+e+\'">\'+e+"</option>").join(""),o=Object.keys(PRESETS.roles).map(e=>\'<option value="\'+e+\'">\'+e+"</option>").join(""),n=\'<div id="\'+e+\'" style="position:fixed; top:10px; right:10px; z-index:9999; background:white; padding:20px; border-radius:8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);"><h3>Identity Manager Form Filler</h3><label>Location:</label><select id="_idm_loc_select" style="width:100%; margin-bottom:10px;">\'+t+\'</select><label>Role:</label><select id="_idm_role_select" style="width:100%; margin-bottom:10px;">\'+o+\'</select><button id="_idm_fill_btn">Fill Form</button> <button onclick="this.parentElement.remove()">Cancel</button></div>\';document.body.insertAdjacentHTML("beforeend",n),document.getElementById("_idm_fill_btn").onclick=()=>{const t=document.getElementById("_idm_loc_select").value,o=document.getElementById("_idm_role_select").value,n={...PRESETS.defaults,...PRESETS.locations[t]||{},...PRESETS.roles[o]||{}};applyPresets(n),document.getElementById(e).remove()}}startApp();';
       const minifiedFinal = finalLogic.replace(/\s+/g, ' ');
       const finalScript = 'javascript:(function(){' + encodeURIComponent(minifiedFinal) + '})()';
       
       const container = document.getElementById('final-bookmarklet-link-container');
       container.innerHTML = '<a href="' + finalScript.replace(/"/g, '&quot;') + '" class="btn btn-primary" style="background-color:var(--green);">' + name + '</a>';
       document.getElementById('final-output').style.display = 'block';
    }
};

app.init();
</script>
</body>
</html>

